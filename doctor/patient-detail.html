<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ‚£è€…è©³æƒ… - DentAI</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    .patient-header-card {
      background: linear-gradient(135deg, #60A5FA, #3B82F6);
      color: white;
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .patient-info-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .patient-avatar-lg {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .patient-detail-info h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .patient-detail-info p {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .health-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    
    .metric-box {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
    }
    
    .metric-value {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
    }
    
    .metric-label {
      font-size: 10px;
      opacity: 0.9;
    }
    
    .tab-navigation {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
      padding: 4px 0;
    }
    
    .tab-btn {
      padding: 10px 20px;
      border-radius: 20px;
      border: 1px solid #D1D5DB;
      background: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition-fast);
    }
    
    .tab-btn.active {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .timeline-container {
      position: relative;
      padding-left: 24px;
    }
    
    .timeline-line {
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #E5E7EB;
    }
    
    .timeline-item {
      position: relative;
      margin-bottom: 20px;
    }
    
    .timeline-dot {
      position: absolute;
      left: -20px;
      top: 6px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: white;
      border: 3px solid #3B82F6;
      z-index: 1;
    }
    
    .timeline-dot.high-risk {
      border-color: #EF4444;
    }
    
    .timeline-dot.medium-risk {
      border-color: #F59E0B;
    }
    
    .timeline-dot.low-risk {
      border-color: #10B981;
    }
    
    .record-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .record-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .record-date {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    
    .record-details {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .detail-tag {
      background: #F3F4F6;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 12px;
      color: #374151;
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 16px;
    }
    
    .chart-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .trend-chart {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 10px 0;
    }
    
    .trend-bar {
      flex: 1;
      background: linear-gradient(to top, #3B82F6, #60A5FA);
      border-radius: 4px 4px 0 0;
      position: relative;
      min-height: 20px;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .trend-bar:hover {
      opacity: 0.8;
    }
    
    .trend-bar-label {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: #6B7280;
      white-space: nowrap;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .summary-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .summary-title {
      font-size: 13px;
      color: #6B7280;
      margin-bottom: 8px;
    }
    
    .summary-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é ‚éƒ¨å°è¦½ -->
    <header class="app-header">
      <button class="header-back-btn" onclick="window.location.href='patients.html'">â†</button>
      <h1 class="header-title">æ‚£è€…è©³æƒ…</h1>
      <div style="width: 44px;"></div>
    </header>
    
    <!-- å…§å®¹å€åŸŸ -->
    <div class="app-content">
      <!-- æ‚£è€…è³‡è¨Šå¡ -->
      <div class="patient-header-card fade-in">
        <div class="patient-info-row">
          <div class="patient-avatar-lg">ğŸ‘¤</div>
          <div class="patient-detail-info">
            <h2 id="patientName">è¼‰å…¥ä¸­...</h2>
            <p id="patientId">ID: --</p>
          </div>
        </div>
        
        <div class="health-metrics">
          <div class="metric-box">
            <div class="metric-value" id="healthScore">--</div>
            <div class="metric-label">å¥åº·åˆ†æ•¸</div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="totalRecords">0</div>
            <div class="metric-label">ç¸½è¨˜éŒ„</div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="highRiskCount">0</div>
            <div class="metric-label">é«˜é¢¨éšª</div>
          </div>
          <div class="metric-box">
            <div class="metric-value" id="lastVisit">--</div>
            <div class="metric-label">æœ€è¿‘å°±è¨º</div>
          </div>
        </div>
      </div>
      
      <!-- åˆ†é å°è¦½ -->
      <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('timeline')">
          ğŸ“… æ™‚é–“è»¸
        </button>
        <button class="tab-btn" onclick="switchTab('trends')">
          ğŸ“ˆ è¶¨å‹¢åˆ†æ
        </button>
        <button class="tab-btn" onclick="switchTab('summary')">
          ğŸ“Š çµ±è¨ˆæ‘˜è¦
        </button>
      </div>
      
      <!-- æ™‚é–“è»¸åˆ†é  -->
      <div id="timeline" class="tab-content active">
        <div class="timeline-container" id="timelineList">
          <!-- å‹•æ…‹è¼‰å…¥ -->
        </div>
      </div>
      
      <!-- è¶¨å‹¢åˆ†æåˆ†é  -->
      <div id="trends" class="tab-content">
        <div class="chart-container">
          <div class="chart-title">
            <span>ğŸ“ˆ</span>
            <span>é¢¨éšªè©•åˆ†è¶¨å‹¢</span>
          </div>
          <div class="trend-chart" id="trendChart">
            <!-- å‹•æ…‹ç”Ÿæˆåœ–è¡¨ -->
          </div>
        </div>
        
        <div class="chart-container">
          <div class="chart-title">
            <span>âš ï¸</span>
            <span>ç•°å¸¸é¡å‹çµ±è¨ˆ</span>
          </div>
          <div id="anomalyStats">
            <!-- å‹•æ…‹è¼‰å…¥ -->
          </div>
        </div>
      </div>
      
      <!-- çµ±è¨ˆæ‘˜è¦åˆ†é  -->
      <div id="summary" class="tab-content">
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-title">å¹³å‡é¢¨éšªè©•åˆ†</div>
            <div class="summary-value" id="avgScore">--</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">æœ€é«˜é¢¨éšªè©•åˆ†</div>
            <div class="summary-value" id="maxScore" style="color: #EF4444;">--</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">æª¢æ¸¬ç•°å¸¸ç¸½æ•¸</div>
            <div class="summary-value" id="totalAnomalies">--</div>
          </div>
          <div class="summary-card">
            <div class="summary-title">å·²å¯©æ ¸è¨˜éŒ„</div>
            <div class="summary-value" id="reviewedCount" style="color: #10B981;">--</div>
          </div>
        </div>
        
        <div class="chart-container" style="margin-top: 16px;">
          <div class="chart-title">
            <span>ğŸ“‹</span>
            <span>é¢¨éšªç­‰ç´šåˆ†å¸ƒ</span>
          </div>
          <div id="riskDistribution">
            <!-- å‹•æ…‹è¼‰å…¥ -->
          </div>
        </div>
      </div>
      
      <div style="height: 100px;"></div>
    </div>
    
    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="bottom-nav">
      <a href="dashboard.html" class="nav-item">
        <div class="nav-icon">ğŸ“Š</div>
        <div>å„€è¡¨æ¿</div>
      </a>
      <a href="review.html" class="nav-item">
        <div class="nav-icon">ğŸ“‹</div>
        <div>å¯©æ ¸</div>
      </a>
      <a href="patients.html" class="nav-item active">
        <div class="nav-icon">ğŸ‘¥</div>
        <div>æ‚£è€…</div>
      </a>
      <a href="doctor-profile.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¨â€âš•ï¸</div>
        <div>æˆ‘çš„</div>
      </a>
    </nav>
  </div>
  
  <script src="../assets/js/storage.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ai-engine.js"></script>
  <script>
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    if (!UserManager.isLoggedIn()) {
      window.location.href = '../patient/login.html';
    }
    
    // å¾ URL ç²å–æ‚£è€… ID
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get('id');
    
    if (!patientId) {
      window.location.href = 'patients.html';
    }
    
    let patientData = null;
    
    // è¼‰å…¥æ‚£è€…è³‡æ–™
    function loadPatientData() {
      const allAnalyses = StorageManager.get(StorageManager.KEYS.ANALYSES) || [];
      const patientAnalyses = allAnalyses.filter(a => a.userId === patientId);
      
      if (patientAnalyses.length === 0) {
        Utils.showToast('æ‰¾ä¸åˆ°æ‚£è€…è³‡æ–™', 'error');
        window.location.href = 'patients.html';
        return;
      }
      
      // æ’åºè¨˜éŒ„ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
      patientAnalyses.sort((a, b) => new Date(b.analyzedAt) - new Date(a.analyzedAt));
      
      const latestAnalysis = patientAnalyses[0];
      const avgScore = Math.round(
        patientAnalyses.reduce((sum, a) => sum + a.riskScore, 0) / patientAnalyses.length
      );
      const healthScore = 100 - avgScore;
      
      patientData = {
        id: patientId,
        name: latestAnalysis.userName,
        analyses: patientAnalyses,
        healthScore,
        avgScore,
        totalRecords: patientAnalyses.length,
        highRiskCount: patientAnalyses.filter(a => a.riskLevel === 'high').length,
        mediumRiskCount: patientAnalyses.filter(a => a.riskLevel === 'medium').length,
        lowRiskCount: patientAnalyses.filter(a => a.riskLevel === 'low').length,
        reviewedCount: patientAnalyses.filter(a => a.status === 'reviewed').length,
        lastVisit: latestAnalysis.analyzedAt
      };
      
      displayPatientHeader();
      displayTimeline();
    }
    
    // é¡¯ç¤ºæ‚£è€…é ­éƒ¨è³‡è¨Š
    function displayPatientHeader() {
      document.getElementById('patientName').textContent = patientData.name;
      document.getElementById('patientId').textContent = `ID: ${patientData.id}`;
      
      const scoreColor = patientData.healthScore >= 70 ? '#FFFFFF' :
                        patientData.healthScore >= 40 ? '#FEF3C7' : '#FEE2E2';
      document.getElementById('healthScore').textContent = patientData.healthScore;
      document.getElementById('healthScore').style.color = scoreColor;
      
      document.getElementById('totalRecords').textContent = patientData.totalRecords;
      document.getElementById('highRiskCount').textContent = patientData.highRiskCount;
      
      const daysSince = Math.floor((Date.now() - new Date(patientData.lastVisit).getTime()) / (1000 * 60 * 60 * 24));
      document.getElementById('lastVisit').textContent = daysSince === 0 ? 'ä»Šå¤©' : `${daysSince}å¤©å‰`;
    }
    
    // é¡¯ç¤ºæ™‚é–“è»¸
    function displayTimeline() {
      const container = document.getElementById('timelineList');
      
      container.innerHTML = patientData.analyses.map((analysis, index) => {
        return `
          <div class="timeline-item" style="animation: slideUp 0.3s ease-out ${index * 0.05}s both;">
            <div class="timeline-dot ${analysis.riskLevel}-risk"></div>
            <div class="record-card" onclick="viewAnalysis('${analysis.id}')">
              <div class="record-header">
                <div class="record-date">${Utils.formatDateTime(analysis.analyzedAt)}</div>
                <span class="badge badge-${analysis.riskLevel}">
                  ${analysis.riskLevelName}
                </span>
              </div>
              <div class="record-details">
                <div class="detail-tag">è©•åˆ† ${analysis.riskScore}</div>
                <div class="detail-tag">${analysis.anomalies.length} é …ç•°å¸¸</div>
                <div class="detail-tag">${analysis.status === 'reviewed' ? 'âœ“ å·²å¯©æ ¸' : 'â³ å¾…å¯©æ ¸'}</div>
              </div>
              ${analysis.status === 'reviewed' ? `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #F3F4F6;">
                  <div style="font-size: 12px; color: #6B7280;">
                    é†«å¸«æ„è¦‹ï¼š${analysis.doctorNotes?.substring(0, 50)}${analysis.doctorNotes?.length > 50 ? '...' : ''}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // é¡¯ç¤ºè¶¨å‹¢åœ–è¡¨
    function displayTrends() {
      const chartContainer = document.getElementById('trendChart');
      const recentAnalyses = patientData.analyses.slice(0, 10).reverse();
      
      const maxScore = Math.max(...recentAnalyses.map(a => a.riskScore));
      
      chartContainer.innerHTML = recentAnalyses.map((analysis, index) => {
        const height = (analysis.riskScore / maxScore) * 100;
        const color = analysis.riskLevel === 'high' ? '#EF4444' :
                     analysis.riskLevel === 'medium' ? '#F59E0B' : '#10B981';
        
        return `
          <div class="trend-bar" 
               style="height: ${height}%; background: linear-gradient(to top, ${color}, ${color}cc);"
               title="é¢¨éšªè©•åˆ†: ${analysis.riskScore}">
            <div class="trend-bar-label">
              ${new Date(analysis.analyzedAt).getMonth() + 1}/${new Date(analysis.analyzedAt).getDate()}
            </div>
          </div>
        `;
      }).join('');
      
      // ç•°å¸¸é¡å‹çµ±è¨ˆ
      displayAnomalyStats();
    }
    
    // é¡¯ç¤ºç•°å¸¸çµ±è¨ˆ
    function displayAnomalyStats() {
      const anomalyMap = new Map();
      
      patientData.analyses.forEach(analysis => {
        analysis.anomalies.forEach(anomaly => {
          const count = anomalyMap.get(anomaly.type) || 0;
          anomalyMap.set(anomaly.type, count + 1);
        });
      });
      
      const anomalyConfig = {
        caries: { name: 'é½²é½’', icon: 'ğŸ¦·', color: '#FEE2E2' },
        calculus: { name: 'ç‰™çµçŸ³', icon: 'ğŸ’', color: '#FEF3C7' },
        gingivitis: { name: 'ç‰™é½¦ç‚', icon: 'ğŸ”´', color: '#FECACA' },
        stain: { name: 'è‰²ç´ æ²‰è‘—', icon: 'ğŸŸ¤', color: '#FDE68A' },
        recession: { name: 'ç‰™é½¦èç¸®', icon: 'ğŸ“‰', color: '#DBEAFE' }
      };
      
      const container = document.getElementById('anomalyStats');
      const total = Array.from(anomalyMap.values()).reduce((sum, count) => sum + count, 0);
      
      container.innerHTML = Array.from(anomalyMap.entries()).map(([type, count]) => {
        const config = anomalyConfig[type] || { name: type, icon: 'âš ï¸', color: '#E5E7EB' };
        const percentage = ((count / total) * 100).toFixed(1);
        
        return `
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="width: 36px; height: 36px; background: ${config.color}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
              ${config.icon}
            </div>
            <div style="flex: 1;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 14px; font-weight: 500;">${config.name}</span>
                <span style="font-size: 14px; font-weight: 600; color: #3B82F6;">${count} æ¬¡</span>
              </div>
              <div style="height: 6px; background: #F3F4F6; border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: ${percentage}%; background: #3B82F6; border-radius: 3px;"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
    function displaySummary() {
      document.getElementById('avgScore').textContent = patientData.avgScore;
      
      const maxScore = Math.max(...patientData.analyses.map(a => a.riskScore));
      document.getElementById('maxScore').textContent = maxScore;
      
      const totalAnomalies = patientData.analyses.reduce((sum, a) => sum + a.anomalies.length, 0);
      document.getElementById('totalAnomalies').textContent = totalAnomalies;
      
      document.getElementById('reviewedCount').textContent = patientData.reviewedCount;
      
      // é¢¨éšªç­‰ç´šåˆ†å¸ƒ
      displayRiskDistribution();
    }
    
    // é¡¯ç¤ºé¢¨éšªåˆ†å¸ƒ
    function displayRiskDistribution() {
      const container = document.getElementById('riskDistribution');
      const total = patientData.totalRecords;
      
      const distribution = [
        { level: 'high', name: 'é«˜é¢¨éšª', count: patientData.highRiskCount, color: '#EF4444' },
        { level: 'medium', name: 'ä¸­é¢¨éšª', count: patientData.mediumRiskCount, color: '#F59E0B' },
        { level: 'low', name: 'ä½é¢¨éšª', count: patientData.lowRiskCount, color: '#10B981' }
      ];
      
      container.innerHTML = distribution.map(item => {
        const percentage = ((item.count / total) * 100).toFixed(1);
        return `
          <div style="margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              <span style="font-size: 14px; font-weight: 500; color: ${item.color};">${item.name}</span>
              <span style="font-size: 14px; font-weight: 600;">${item.count} æ¬¡ (${percentage}%)</span>
            </div>
            <div style="height: 8px; background: #F3F4F6; border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; width: ${percentage}%; background: ${item.color}; border-radius: 4px; transition: width 0.5s ease-out;"></div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // åˆ‡æ›åˆ†é 
    function switchTab(tabName) {
      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      document.querySelectorAll('.tab-btn').forEach((btn, index) => {
        btn.classList.toggle('active', 
          (tabName === 'timeline' && index === 0) ||
          (tabName === 'trends' && index === 1) ||
          (tabName === 'summary' && index === 2)
        );
      });
      
      // æ›´æ–°å…§å®¹é¡¯ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');
      
      // è¼‰å…¥å°æ‡‰æ•¸æ“š
      if (tabName === 'trends') {
        displayTrends();
      } else if (tabName === 'summary') {
        displaySummary();
      }
    }
    
    // æŸ¥çœ‹åˆ†æè©³æƒ…
    function viewAnalysis(analysisId) {
      window.location.href = `review.html?id=${analysisId}`;
    }
    
    // åˆå§‹åŒ–é é¢
    loadPatientData();
  </script>
</body>
</html>
