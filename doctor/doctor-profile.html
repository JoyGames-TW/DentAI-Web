<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é†«å¸«å€‹äººä¸­å¿ƒ - DentAI</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    .profile-header {
      background: linear-gradient(135deg, #0EA5E9 0%, #2563EB 100%);
      color: white;
      padding: 32px 24px;
      margin: -16px -16px 24px -16px;
      border-radius: 0 0 24px 24px;
      text-align: center;
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 16px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .profile-name {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .profile-specialty {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    
    .profile-hospital {
      font-size: 13px;
      opacity: 0.8;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .stat-box {
      background: white;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .stat-box-value {
      font-size: 28px;
      font-weight: 700;
      color: #3B82F6;
      margin-bottom: 4px;
    }
    
    .stat-box-label {
      font-size: 12px;
      color: #6B7280;
    }
    
    .menu-section {
      margin-bottom: 20px;
    }
    
    .section-label {
      font-size: 13px;
      font-weight: 600;
      color: #6B7280;
      text-transform: uppercase;
      margin-bottom: 8px;
      padding: 0 4px;
    }
    
    .menu-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #F3F4F6;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .menu-item:last-child {
      border-bottom: none;
    }
    
    .menu-item:hover {
      background: #F9FAFB;
    }
    
    .menu-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 12px;
    }
    
    .menu-content {
      flex: 1;
    }
    
    .menu-title {
      font-size: 15px;
      font-weight: 500;
      color: #111827;
      margin-bottom: 2px;
    }
    
    .menu-subtitle {
      font-size: 12px;
      color: #9CA3AF;
    }
    
    .menu-arrow {
      color: #9CA3AF;
      font-size: 20px;
    }
    
    .logout-button {
      width: 100%;
      padding: 16px;
      background: white;
      color: #EF4444;
      border: 2px solid #EF4444;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      margin-top: 20px;
    }
    
    .logout-button:hover {
      background: #FEE2E2;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é ‚éƒ¨å°è¦½ -->
    <header class="app-header" style="background: linear-gradient(135deg, #0EA5E9 0%, #2563EB 100%); border: none; color: white;">
      <div style="width: 44px;"></div>
      <h1 class="header-title" style="color: white;">å€‹äººä¸­å¿ƒ</h1>
      <div style="width: 44px;"></div>
    </header>
    
    <!-- å…§å®¹å€åŸŸ -->
    <div class="app-content">
      <!-- å€‹äººè³‡è¨Šé ­éƒ¨ -->
      <div class="profile-header fade-in">
        <div class="profile-avatar">ğŸ‘¨â€âš•ï¸</div>
        <div class="profile-name" id="doctorName">è¼‰å…¥ä¸­...</div>
        <div class="profile-specialty" id="doctorSpecialty">--</div>
        <div class="profile-hospital" id="doctorHospital">--</div>
      </div>
      
      <!-- çµ±è¨ˆæ•¸æ“š -->
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-box-value" id="todayReviewed">0</div>
          <div class="stat-box-label">ä»Šæ—¥å¯©æ ¸</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="totalReviewed">0</div>
          <div class="stat-box-label">ç¸½å¯©æ ¸æ•¸</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="totalPatients">0</div>
          <div class="stat-box-label">ç®¡ç†æ‚£è€…</div>
        </div>
      </div>
      
      <!-- å·¥ä½œç›¸é—œ -->
      <div class="menu-section">
        <div class="section-label">å·¥ä½œç®¡ç†</div>
        <div class="menu-card">
          <div class="menu-item" onclick="window.location.href='dashboard.html'">
            <div class="menu-icon" style="background: #DBEAFE;">ğŸ“Š</div>
            <div class="menu-content">
              <div class="menu-title">å·¥ä½œå„€è¡¨æ¿</div>
              <div class="menu-subtitle">æŸ¥çœ‹å¾…å¯©æ ¸æ¡ˆä»¶</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
          
          <div class="menu-item" onclick="window.location.href='review.html'">
            <div class="menu-icon" style="background: #E0E7FF;">ğŸ“</div>
            <div class="menu-content">
              <div class="menu-title">å¯©æ ¸ä¸­å¿ƒ</div>
              <div class="menu-subtitle">å¯©æ ¸æ‚£è€…ç—…ä¾‹</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
          
          <div class="menu-item" onclick="window.location.href='patients.html'">
            <div class="menu-icon" style="background: #DBEAFE;">ğŸ‘¥</div>
            <div class="menu-content">
              <div class="menu-title">æ‚£è€…ç®¡ç†</div>
              <div class="menu-subtitle">ç®¡ç†æ‰€æœ‰æ‚£è€…</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
        </div>
      </div>
      
      <!-- è³‡æ–™èˆ‡å ±è¡¨ -->
      <div class="menu-section">
        <div class="section-label">æ•¸æ“šåˆ†æ</div>
        <div class="menu-card">
          <div class="menu-item" onclick="exportReviewData()">
            <div class="menu-icon" style="background: #D1FAE5;">ğŸ“Š</div>
            <div class="menu-content">
              <div class="menu-title">å¯©æ ¸çµ±è¨ˆ</div>
              <div class="menu-subtitle">æŸ¥çœ‹å¯©æ ¸æ•¸æ“šå ±è¡¨</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
          
          <div class="menu-item" onclick="exportPatientData()">
            <div class="menu-icon" style="background: #FEF3C7;">ğŸ’¾</div>
            <div class="menu-content">
              <div class="menu-title">åŒ¯å‡ºæ•¸æ“š</div>
              <div class="menu-subtitle">ä¸‹è¼‰æ‚£è€…è³‡æ–™</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
        </div>
      </div>
      
      <!-- è¨­å®š -->
      <div class="menu-section">
        <div class="section-label">è¨­å®š</div>
        <div class="menu-card">
          <div class="menu-item" onclick="Utils.showToast('åŠŸèƒ½é–‹ç™¼ä¸­', 'info')">
            <div class="menu-icon" style="background: #E5E7EB;">ğŸ‘¤</div>
            <div class="menu-content">
              <div class="menu-title">å€‹äººè³‡æ–™</div>
              <div class="menu-subtitle">ç·¨è¼¯å€‹äººè³‡è¨Š</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
          
          <div class="menu-item" onclick="Utils.showToast('åŠŸèƒ½é–‹ç™¼ä¸­', 'info')">
            <div class="menu-icon" style="background: #FEE2E2;">ğŸ”’</div>
            <div class="menu-content">
              <div class="menu-title">ä¿®æ”¹å¯†ç¢¼</div>
              <div class="menu-subtitle">æ›´æ”¹ç™»å…¥å¯†ç¢¼</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
          
          <div class="menu-item" onclick="Utils.showToast('åŠŸèƒ½é–‹ç™¼ä¸­', 'info')">
            <div class="menu-icon" style="background: #FEF3C7;">ğŸ””</div>
            <div class="menu-content">
              <div class="menu-title">é€šçŸ¥è¨­å®š</div>
              <div class="menu-subtitle">ç®¡ç†é€šçŸ¥åå¥½</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
        </div>
      </div>
      
      <!-- é—œæ–¼ -->
      <div class="menu-section">
        <div class="section-label">å…¶ä»–</div>
        <div class="menu-card">
          <div class="menu-item" onclick="Utils.showToast('ç‰ˆæœ¬ï¼š1.0.0 (Beta)', 'info')">
            <div class="menu-icon" style="background: #E0E7FF;">â„¹ï¸</div>
            <div class="menu-content">
              <div class="menu-title">é—œæ–¼ DentAI</div>
              <div class="menu-subtitle">ç‰ˆæœ¬è³‡è¨Šèˆ‡èªªæ˜</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
          
          <div class="menu-item" onclick="Utils.showToast('åŠŸèƒ½é–‹ç™¼ä¸­', 'info')">
            <div class="menu-icon" style="background: #DBEAFE;">â“</div>
            <div class="menu-content">
              <div class="menu-title">å¹«åŠ©ä¸­å¿ƒ</div>
              <div class="menu-subtitle">å¸¸è¦‹å•é¡Œèˆ‡æ”¯æ´</div>
            </div>
            <div class="menu-arrow">â†’</div>
          </div>
        </div>
      </div>
      
      <!-- ç™»å‡ºæŒ‰éˆ• -->
      <button class="logout-button" onclick="handleLogout()">
        ğŸšª ç™»å‡ºç³»çµ±
      </button>
    </div>
    
    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="bottom-nav">
      <a href="dashboard.html" class="nav-item">
        <div class="nav-icon">ğŸ“Š</div>
        <div>å„€è¡¨æ¿</div>
      </a>
      <a href="review.html" class="nav-item">
        <div class="nav-icon">ğŸ“‹</div>
        <div>å¯©æ ¸</div>
      </a>
      <a href="patients.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¥</div>
        <div>æ‚£è€…</div>
      </a>
      <a href="doctor-profile.html" class="nav-item active">
        <div class="nav-icon">ğŸ‘¨â€âš•ï¸</div>
        <div>æˆ‘çš„</div>
      </a>
    </nav>
  </div>
  
  <script src="../assets/js/storage.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ai-engine.js"></script>
  <script>
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    if (!UserManager.isLoggedIn()) {
      window.location.href = '../patient/login.html';
    }
    
    const currentUser = UserManager.getCurrentUser();
    
    // è¼‰å…¥é†«å¸«è³‡è¨Š
    function loadDoctorInfo() {
      document.getElementById('doctorName').textContent = currentUser.name;
      document.getElementById('doctorSpecialty').textContent = currentUser.specialty;
      document.getElementById('doctorHospital').textContent = currentUser.hospital;
    }
    
    // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
    function loadStats() {
      const allAnalyses = StorageManager.get(StorageManager.KEYS.ANALYSES) || [];
      
      // ä»Šæ—¥å¯©æ ¸æ•¸
      const today = new Date().toDateString();
      const todayReviewed = allAnalyses.filter(a => 
        a.status === 'reviewed' && 
        a.reviewedBy === currentUser.id &&
        a.reviewedAt && 
        new Date(a.reviewedAt).toDateString() === today
      ).length;
      document.getElementById('todayReviewed').textContent = todayReviewed;
      
      // ç¸½å¯©æ ¸æ•¸
      const totalReviewed = allAnalyses.filter(a => 
        a.status === 'reviewed' && 
        a.reviewedBy === currentUser.id
      ).length;
      document.getElementById('totalReviewed').textContent = totalReviewed;
      
      // ç®¡ç†æ‚£è€…æ•¸ï¼ˆæœ‰å¯©æ ¸è¨˜éŒ„çš„æ‚£è€…ï¼‰
      const patientIds = new Set(
        allAnalyses
          .filter(a => a.reviewedBy === currentUser.id)
          .map(a => a.userId)
      );
      document.getElementById('totalPatients').textContent = patientIds.size;
    }
    
    // åŒ¯å‡ºå¯©æ ¸æ•¸æ“š
    function exportReviewData() {
      const allAnalyses = StorageManager.get(StorageManager.KEYS.ANALYSES) || [];
      const myReviews = allAnalyses.filter(a => 
        a.status === 'reviewed' && 
        a.reviewedBy === currentUser.id
      );
      
      const statsData = {
        doctor: {
          id: currentUser.id,
          name: currentUser.name,
          specialty: currentUser.specialty,
          hospital: currentUser.hospital
        },
        summary: {
          totalReviews: myReviews.length,
          highRiskCases: myReviews.filter(r => r.riskLevel === 'high').length,
          mediumRiskCases: myReviews.filter(r => r.riskLevel === 'medium').length,
          lowRiskCases: myReviews.filter(r => r.riskLevel === 'low').length
        },
        reviews: myReviews.map(r => ({
          id: r.id,
          patientId: r.userId,
          patientName: r.userName,
          riskLevel: r.riskLevelName,
          riskScore: r.riskScore,
          anomalies: r.anomalies.length,
          reviewedAt: r.reviewedAt,
          doctorNotes: r.doctorNotes
        })),
        exportedAt: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(statsData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `å¯©æ ¸çµ±è¨ˆ_${currentUser.name}_${Utils.formatDateTime(new Date()).replace(/[/:]/g, '-')}.json`;
      a.click();
      
      Utils.showToast('å¯©æ ¸çµ±è¨ˆå·²åŒ¯å‡º', 'success');
    }
    
    // åŒ¯å‡ºæ‚£è€…æ•¸æ“š
    function exportPatientData() {
      const allAnalyses = StorageManager.get(StorageManager.KEYS.ANALYSES) || [];
      
      // æŒ‰æ‚£è€…åˆ†çµ„
      const patientMap = new Map();
      allAnalyses.forEach(analysis => {
        if (!patientMap.has(analysis.userId)) {
          patientMap.set(analysis.userId, {
            id: analysis.userId,
            name: analysis.userName,
            records: []
          });
        }
        patientMap.get(analysis.userId).records.push({
          id: analysis.id,
          date: analysis.analyzedAt,
          riskLevel: analysis.riskLevelName,
          riskScore: analysis.riskScore,
          anomalies: analysis.anomalies.length,
          status: analysis.status,
          reviewed: analysis.status === 'reviewed',
          reviewedBy: analysis.reviewedByName,
          reviewedAt: analysis.reviewedAt
        });
      });
      
      const patientsData = {
        exportedBy: currentUser.name,
        totalPatients: patientMap.size,
        patients: Array.from(patientMap.values()).map(p => ({
          ...p,
          totalRecords: p.records.length,
          highRiskRecords: p.records.filter(r => r.riskLevel === 'é«˜é¢¨éšª').length,
          avgRiskScore: Math.round(
            p.records.reduce((sum, r) => sum + r.riskScore, 0) / p.records.length
          )
        })),
        exportedAt: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(patientsData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `æ‚£è€…æ•¸æ“š_${Utils.formatDateTime(new Date()).replace(/[/:]/g, '-')}.json`;
      a.click();
      
      Utils.showToast('æ‚£è€…æ•¸æ“šå·²åŒ¯å‡º', 'success');
    }
    
    // ç™»å‡º
    function handleLogout() {
      Utils.showConfirm(
        'ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ',
        () => {
          UserManager.logout();
          Utils.showToast('å·²ç™»å‡º', 'success');
          setTimeout(() => {
            window.location.href = '../patient/login.html';
          }, 1000);
        }
      );
    }
    
    // åˆå§‹åŒ–
    loadDoctorInfo();
    loadStats();
  </script>
</body>
</html>
