<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å¯©æ ¸ç—…ä¾‹ - DentAI</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    .patient-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .patient-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .patient-avatar-large {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60A5FA, #3B82F6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .patient-details h2 {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    
    .patient-meta-info {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: #6B7280;
    }
    
    .image-viewer {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .image-canvas {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    #reviewImage {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .image-tools {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      overflow-x: auto;
      padding: 4px 0;
    }
    
    .tool-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #D1D5DB;
      background: white;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition-fast);
    }
    
    .tool-btn:hover {
      background: #F3F4F6;
    }
    
    .tool-btn.active {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    .ai-analysis-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .risk-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: #F9FAFB;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .risk-score {
      text-align: center;
    }
    
    .risk-score-value {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .risk-score-label {
      font-size: 12px;
      color: #6B7280;
      text-transform: uppercase;
    }
    
    .anomaly-item {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .anomaly-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .anomaly-info {
      flex: 1;
    }
    
    .anomaly-name {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 2px;
    }
    
    .anomaly-location {
      font-size: 12px;
      color: #6B7280;
    }
    
    .anomaly-confidence {
      text-align: right;
      font-size: 12px;
      color: #6B7280;
    }
    
    .doctor-notes-section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .notes-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
    }
    
    .notes-textarea:focus {
      outline: none;
      border-color: #3B82F6;
    }
    
    .quick-notes {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    .quick-note-chip {
      padding: 6px 12px;
      background: #F3F4F6;
      border-radius: 16px;
      font-size: 12px;
      color: #374151;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .quick-note-chip:hover {
      background: #E5E7EB;
    }
    
    .review-actions {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 428px;
      width: 100%;
      background: white;
      border-top: 1px solid #E5E7EB;
      padding: 16px;
      display: flex;
      gap: 12px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      z-index: 100;
    }
    
    .action-button {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .action-button.approve {
      background: #10B981;
      color: white;
    }
    
    .action-button.reject {
      background: #EF4444;
      color: white;
    }
    
    .action-button.request-more {
      background: #F59E0B;
      color: white;
    }
    
    .action-button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .action-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .case-list {
      padding-bottom: 20px;
    }
    
    .filter-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 4px 0;
      margin-bottom: 16px;
    }
    
    .filter-tab {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #D1D5DB;
      background: white;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition-fast);
    }
    
    .filter-tab.active {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    .case-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: var(--transition-fast);
      border-left: 4px solid transparent;
    }
    
    .case-item:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .case-item.high-risk { border-left-color: #EF4444; }
    .case-item.medium-risk { border-left-color: #F59E0B; }
    .case-item.low-risk { border-left-color: #10B981; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é ‚éƒ¨å°è¦½ -->
    <header class="app-header">
      <button class="header-back-btn" onclick="goBack()">â†</button>
      <h1 class="header-title" id="pageTitle">ç—…ä¾‹å¯©æ ¸</h1>
      <div style="width: 44px;"></div>
    </header>
    
    <!-- å…§å®¹å€åŸŸ -->
    <div class="app-content">
      <!-- æ¡ˆä»¶åˆ—è¡¨æ¨¡å¼ -->
      <div id="listMode" style="display: none;">
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all" onclick="filterCases('all')">
            å…¨éƒ¨ (<span id="countAll">0</span>)
          </button>
          <button class="filter-tab" data-filter="high" onclick="filterCases('high')">
            é«˜é¢¨éšª (<span id="countHigh">0</span>)
          </button>
          <button class="filter-tab" data-filter="medium" onclick="filterCases('medium')">
            ä¸­é¢¨éšª (<span id="countMedium">0</span>)
          </button>
          <button class="filter-tab" data-filter="low" onclick="filterCases('low')">
            ä½é¢¨éšª (<span id="countLow">0</span>)
          </button>
        </div>
        
        <div class="case-list" id="caseList">
          <!-- å‹•æ…‹è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨ -->
        </div>
      </div>
      
      <!-- å¯©æ ¸æ¨¡å¼ -->
      <div id="reviewMode" style="display: none;">
        <!-- æ‚£è€…è³‡è¨Šå¡ -->
        <div class="patient-card fade-in">
          <div class="patient-header">
            <div class="patient-avatar-large">ğŸ‘¤</div>
            <div class="patient-details">
              <h2 id="patientName">--</h2>
              <div class="patient-meta-info">
                <span id="patientId">ID: --</span>
                <span id="patientAge">å¹´é½¡: --</span>
                <span id="uploadTime">--</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- å½±åƒæª¢è¦–å™¨ -->
        <div class="image-viewer">
          <div class="image-canvas">
            <img id="reviewImage" src="" alt="å£è…”å½±åƒ">
          </div>
          <div class="image-tools">
            <button class="tool-btn" onclick="zoomIn()">ğŸ” æ”¾å¤§</button>
            <button class="tool-btn" onclick="zoomOut()">ğŸ” ç¸®å°</button>
            <button class="tool-btn" onclick="resetZoom()">â†» é‡ç½®</button>
            <button class="tool-btn" id="brightnessBtn" onclick="toggleBrightness()">â˜€ï¸ äº®åº¦</button>
            <button class="tool-btn" id="contrastBtn" onclick="toggleContrast()">â— å°æ¯”</button>
          </div>
        </div>
        
        <!-- AI åˆ†æçµæœ -->
        <div class="ai-analysis-card">
          <div class="section-title">
            <span>ğŸ¤–</span>
            <span>AI åˆ†æçµæœ</span>
          </div>
          
          <div class="risk-display">
            <div class="risk-score">
              <div class="risk-score-value" id="riskScoreValue" style="color: #EF4444;">--</div>
              <div class="risk-score-label">é¢¨éšªè©•åˆ†</div>
            </div>
            <div style="flex: 1; text-align: center;">
              <span class="badge" id="riskBadge" style="font-size: 16px; padding: 8px 16px;">--</span>
            </div>
          </div>
          
          <div class="section-title" style="margin-top: 16px;">
            <span>âš ï¸</span>
            <span>æª¢æ¸¬ç•°å¸¸ (<span id="anomalyCount">0</span>)</span>
          </div>
          
          <div id="anomalyList">
            <!-- å‹•æ…‹è¼‰å…¥ç•°å¸¸åˆ—è¡¨ -->
          </div>
        </div>
        
        <!-- é†«å¸«å¯©æ ¸æ„è¦‹ -->
        <div class="doctor-notes-section">
          <div class="section-title">
            <span>ğŸ“</span>
            <span>å¯©æ ¸æ„è¦‹</span>
          </div>
          
          <textarea 
            id="doctorNotes" 
            class="notes-textarea" 
            placeholder="è«‹è¼¸å…¥æ‚¨çš„å°ˆæ¥­æ„è¦‹å’Œå»ºè­°..."></textarea>
          
          <div class="quick-notes">
            <div class="quick-note-chip" onclick="addQuickNote('å»ºè­°é€²è¡Œé€²ä¸€æ­¥æª¢æŸ¥')">å»ºè­°é€²ä¸€æ­¥æª¢æŸ¥</div>
            <div class="quick-note-chip" onclick="addQuickNote('éœ€è¦å®‰æ’æ²»ç™‚')">éœ€è¦å®‰æ’æ²»ç™‚</div>
            <div class="quick-note-chip" onclick="addQuickNote('å®šæœŸè¿½è¹¤å³å¯')">å®šæœŸè¿½è¹¤å³å¯</div>
            <div class="quick-note-chip" onclick="addQuickNote('æ³¨æ„å£è…”è¡›ç”Ÿ')">æ³¨æ„å£è…”è¡›ç”Ÿ</div>
            <div class="quick-note-chip" onclick="addQuickNote('ç„¡æ˜é¡¯ç•°å¸¸')">ç„¡æ˜é¡¯ç•°å¸¸</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- åº•éƒ¨æ“ä½œæŒ‰éˆ• (åƒ…åœ¨å¯©æ ¸æ¨¡å¼é¡¯ç¤º) -->
    <div class="review-actions" id="reviewActions" style="display: none;">
      <button class="action-button approve" onclick="approveCase()">
        âœ“ æ‰¹å‡†
      </button>
      <button class="action-button request-more" onclick="requestMore()">
        âš ï¸ éœ€è£œå……
      </button>
      <button class="action-button reject" onclick="rejectCase()">
        âœ— é€€å›
      </button>
    </div>
    
    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="bottom-nav">
      <a href="dashboard.html" class="nav-item">
        <div class="nav-icon">ğŸ“Š</div>
        <div>å„€è¡¨æ¿</div>
      </a>
      <a href="review.html" class="nav-item">
        <div class="nav-icon">ğŸ“‹</div>
        <div>å¯©æ ¸</div>
      </a>
      <a href="patients.html" class="nav-item active">
        <div class="nav-icon">ğŸ‘¥</div>
        <div>æ‚£è€…</div>
      </a>
      <a href="doctor-profile.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¨â€âš•ï¸</div>
        <div>æˆ‘çš„</div>
      </a>
    </nav>
  </div>
  
  <script src="../assets/js/storage.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ai-engine.js"></script>
  <script>
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    if (!UserManager.isLoggedIn()) {
      window.location.href = '../patient/login.html';
    }
    
    const currentUser = UserManager.getCurrentUser();
    let currentAnalysisId = null;
    let currentFilter = 'all';
    let imageZoom = 1;
    let imageBrightness = 100;
    let imageContrast = 100;
    
    // å¾ URL ç²å–åƒæ•¸
    const urlParams = new URLSearchParams(window.location.search);
    const reviewId = urlParams.get('id');
    const viewMode = urlParams.get('mode');
    
    // åˆå§‹åŒ–é é¢
    function initPage() {
      if (reviewId) {
        // å–®ä¸€å¯©æ ¸æ¨¡å¼
        showReviewMode(reviewId);
      } else {
        // æ¡ˆä»¶åˆ—è¡¨æ¨¡å¼
        showListMode();
      }
    }
    
    // é¡¯ç¤ºåˆ—è¡¨æ¨¡å¼
    function showListMode() {
      document.getElementById('listMode').style.display = 'block';
      document.getElementById('reviewMode').style.display = 'none';
      document.getElementById('reviewActions').style.display = 'none';
      document.getElementById('doctorNav').style.display = 'flex';
      document.getElementById('pageTitle').textContent = 'å¾…å¯©æ ¸æ¡ˆä»¶';
      
      loadCaseList();
    }
    
    // é¡¯ç¤ºå¯©æ ¸æ¨¡å¼
    function showReviewMode(analysisId) {
      document.getElementById('listMode').style.display = 'none';
      document.getElementById('reviewMode').style.display = 'block';
      document.getElementById('reviewActions').style.display = 'flex';
      document.getElementById('doctorNav').style.display = 'none';
      document.getElementById('pageTitle').textContent = 'ç—…ä¾‹å¯©æ ¸';
      
      currentAnalysisId = analysisId;
      loadAnalysisData(analysisId);
    }
    
    // è¼‰å…¥æ¡ˆä»¶åˆ—è¡¨
    function loadCaseList() {
      const pendingCases = AnalysisManager.getPendingReviews();
      
      // æ›´æ–°è¨ˆæ•¸
      document.getElementById('countAll').textContent = pendingCases.length;
      document.getElementById('countHigh').textContent = pendingCases.filter(c => c.riskLevel === 'high').length;
      document.getElementById('countMedium').textContent = pendingCases.filter(c => c.riskLevel === 'medium').length;
      document.getElementById('countLow').textContent = pendingCases.filter(c => c.riskLevel === 'low').length;
      
      // é¡¯ç¤ºæ¡ˆä»¶
      displayCaseList(pendingCases);
    }
    
    // é¡¯ç¤ºæ¡ˆä»¶åˆ—è¡¨
    function displayCaseList(cases) {
      const container = document.getElementById('caseList');
      
      let filteredCases = cases;
      if (currentFilter !== 'all') {
        filteredCases = cases.filter(c => c.riskLevel === currentFilter);
      }
      
      // æŒ‰é¢¨éšªç­‰ç´šå’Œæ™‚é–“æ’åº
      filteredCases.sort((a, b) => {
        const riskOrder = { high: 0, medium: 1, low: 2 };
        if (riskOrder[a.riskLevel] !== riskOrder[b.riskLevel]) {
          return riskOrder[a.riskLevel] - riskOrder[b.riskLevel];
        }
        return new Date(b.analyzedAt) - new Date(a.analyzedAt);
      });
      
      if (filteredCases.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #9CA3AF;">
            <div style="font-size: 60px; margin-bottom: 16px;">ğŸ“‹</div>
            <div style="font-size: 16px; font-weight: 600; color: #374151;">
              æ²’æœ‰å¾…å¯©æ ¸æ¡ˆä»¶
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredCases.map((caseData, index) => {
        const icons = { high: 'âš ï¸', medium: 'âš¡', low: 'âœ…' };
        return `
          <div class="case-item ${caseData.riskLevel}-risk" 
               onclick="viewCase('${caseData.id}')"
               style="animation: slideUp 0.3s ease-out ${index * 0.05}s both;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div>
                <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 4px;">
                  ${caseData.userName}
                </div>
                <div style="font-size: 13px; color: #6B7280;">
                  ${Utils.getRelativeTime(caseData.analyzedAt)}
                </div>
              </div>
              <span class="badge badge-${caseData.riskLevel}">
                ${icons[caseData.riskLevel]} ${caseData.riskLevelName}
              </span>
            </div>
            <div style="display: flex; gap: 8px;">
              <div style="background: #F3F4F6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                è©•åˆ† ${caseData.riskScore}
              </div>
              <div style="background: #F3F4F6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                ${caseData.anomalies.length} é …ç•°å¸¸
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // éæ¿¾æ¡ˆä»¶
    function filterCases(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.filter === filter);
      });
      loadCaseList();
    }
    
    // æŸ¥çœ‹æ¡ˆä»¶
    function viewCase(analysisId) {
      window.location.href = `review.html?id=${analysisId}`;
    }
    
    // è¼‰å…¥åˆ†ææ•¸æ“š
    function loadAnalysisData(analysisId) {
      console.log('è¼‰å…¥åˆ†ææ•¸æ“šï¼ŒID:', analysisId);
      
      const analysis = AnalysisManager.getById(analysisId);
      console.log('åˆ†æè¨˜éŒ„:', analysis);
      
      if (!analysis) {
        console.error('æ‰¾ä¸åˆ°è©²åˆ†æè¨˜éŒ„');
        Utils.showToast('æ‰¾ä¸åˆ°è©²åˆ†æè¨˜éŒ„', 'error');
        goBack();
        return;
      }
      
      const image = ImageManager.getById(analysis.imageId);
      console.log('å½±åƒè³‡æ–™:', image);
      
      if (!image) {
        console.error('æ‰¾ä¸åˆ°ç›¸é—œå½±åƒ');
        Utils.showToast('æ‰¾ä¸åˆ°ç›¸é—œå½±åƒ', 'error');
        goBack();
        return;
      }
      
      // é¡¯ç¤ºæ‚£è€…è³‡è¨Š
      document.getElementById('patientName').textContent = analysis.userName || 'æœªçŸ¥æ‚£è€…';
      document.getElementById('patientId').textContent = `ID: ${analysis.userId || '--'}`;
      document.getElementById('uploadTime').textContent = Utils.formatDateTime(analysis.analyzedAt);
      
      // é¡¯ç¤ºå½±åƒ
      const reviewImage = document.getElementById('reviewImage');
      reviewImage.src = image.imageData || '';
      reviewImage.onerror = function() {
        console.error('å½±åƒè¼‰å…¥å¤±æ•—');
        this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="400" height="300" fill="%23f3f4f6"/><text x="50%" y="50%" text-anchor="middle" fill="%236b7280" font-size="16">å½±åƒè¼‰å…¥å¤±æ•—</text></svg>';
      };
      
      // é¡¯ç¤ºé¢¨éšªè©•åˆ†
      const colors = { high: '#EF4444', medium: '#F59E0B', low: '#10B981' };
      const icons = { high: 'âš ï¸', medium: 'âš¡', low: 'âœ…' };
      document.getElementById('riskScoreValue').textContent = analysis.riskScore || '--';
      document.getElementById('riskScoreValue').style.color = colors[analysis.riskLevel] || '#6B7280';
      document.getElementById('riskBadge').className = `badge badge-${analysis.riskLevel || 'low'}`;
      document.getElementById('riskBadge').textContent = `${icons[analysis.riskLevel] || 'âœ“'} ${analysis.riskLevelName || 'æœªçŸ¥'}`;
      
      // é¡¯ç¤ºç•°å¸¸åˆ—è¡¨
      displayAnomalies(analysis.anomalies || []);
      
      // å¦‚æœå·²æœ‰å¯©æ ¸æ„è¦‹ï¼Œé¡¯ç¤º
      if (analysis.doctorNotes) {
        document.getElementById('doctorNotes').value = analysis.doctorNotes;
      }
      
      console.log('æ•¸æ“šè¼‰å…¥å®Œæˆ');
    }
    
    // é¡¯ç¤ºç•°å¸¸åˆ—è¡¨
    function displayAnomalies(anomalies) {
      document.getElementById('anomalyCount').textContent = anomalies.length;
      
      const container = document.getElementById('anomalyList');
      
      if (anomalies.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #9CA3AF; font-size: 14px;">
            æœªæª¢æ¸¬åˆ°æ˜é¡¯ç•°å¸¸
          </div>
        `;
        return;
      }
      
      const anomalyConfig = {
        caries: { name: 'é½²é½’', icon: 'ğŸ¦·', color: '#FEE2E2' },
        calculus: { name: 'ç‰™çµçŸ³', icon: 'ğŸ’', color: '#FEF3C7' },
        gingivitis: { name: 'ç‰™é½¦ç‚', icon: 'ğŸ”´', color: '#FECACA' },
        stain: { name: 'è‰²ç´ æ²‰è‘—', icon: 'ğŸŸ¤', color: '#FDE68A' },
        recession: { name: 'ç‰™é½¦èç¸®', icon: 'ğŸ“‰', color: '#DBEAFE' }
      };
      
      container.innerHTML = anomalies.map(anomaly => {
        const config = anomalyConfig[anomaly.type] || { name: anomaly.type, icon: 'âš ï¸', color: '#E5E7EB' };
        return `
          <div class="anomaly-item">
            <div class="anomaly-icon" style="background: ${config.color};">
              ${config.icon}
            </div>
            <div class="anomaly-info">
              <div class="anomaly-name">${config.name}</div>
              <div class="anomaly-location">${anomaly.location}</div>
            </div>
            <div class="anomaly-confidence">
              ä¿¡å¿ƒåº¦<br>
              <strong>${anomaly.confidence}%</strong>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // å½±åƒæ§åˆ¶åŠŸèƒ½
    function zoomIn() {
      imageZoom = Math.min(imageZoom + 0.2, 3);
      applyImageFilters();
    }
    
    function zoomOut() {
      imageZoom = Math.max(imageZoom - 0.2, 0.5);
      applyImageFilters();
    }
    
    function resetZoom() {
      imageZoom = 1;
      imageBrightness = 100;
      imageContrast = 100;
      applyImageFilters();
      document.getElementById('brightnessBtn').classList.remove('active');
      document.getElementById('contrastBtn').classList.remove('active');
    }
    
    function toggleBrightness() {
      const btn = document.getElementById('brightnessBtn');
      if (btn.classList.contains('active')) {
        imageBrightness = 100;
        btn.classList.remove('active');
      } else {
        imageBrightness = 120;
        btn.classList.add('active');
      }
      applyImageFilters();
    }
    
    function toggleContrast() {
      const btn = document.getElementById('contrastBtn');
      if (btn.classList.contains('active')) {
        imageContrast = 100;
        btn.classList.remove('active');
      } else {
        imageContrast = 120;
        btn.classList.add('active');
      }
      applyImageFilters();
    }
    
    function applyImageFilters() {
      const img = document.getElementById('reviewImage');
      img.style.transform = `scale(${imageZoom})`;
      img.style.filter = `brightness(${imageBrightness}%) contrast(${imageContrast}%)`;
    }
    
    // å¿«é€Ÿç­†è¨˜
    function addQuickNote(text) {
      const textarea = document.getElementById('doctorNotes');
      const currentValue = textarea.value.trim();
      if (currentValue) {
        textarea.value = currentValue + '\n' + text;
      } else {
        textarea.value = text;
      }
    }
    
    // æ‰¹å‡†æ¡ˆä»¶
    function approveCase() {
      const notes = document.getElementById('doctorNotes').value.trim();
      
      if (!notes) {
        Utils.showToast('è«‹è¼¸å…¥å¯©æ ¸æ„è¦‹', 'warning');
        return;
      }
      
      Utils.showConfirm(
        'ç¢ºå®šæ‰¹å‡†æ­¤æ¡ˆä»¶å—ï¼Ÿ',
        () => {
          const success = AnalysisManager.reviewAnalysis(
            currentAnalysisId,
            currentUser.id,
            currentUser.name,
            'approved',
            notes
          );
          
          if (success) {
            // ç™¼é€é€šçŸ¥çµ¦æ‚£è€…
            const analysis = AnalysisManager.getById(currentAnalysisId);
            NotificationManager.createNotification({
              userId: analysis.userId,
              type: 'review',
              title: 'ç—…ä¾‹å¯©æ ¸å®Œæˆ',
              message: `æ‚¨çš„å£è…”å½±åƒå·²é€šéå¯©æ ¸ã€‚é†«å¸«æ„è¦‹ï¼š${notes.substring(0, 50)}...`,
              priority: 'high',
              relatedId: currentAnalysisId
            });
            
            Utils.showToast('å¯©æ ¸å®Œæˆ', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            Utils.showToast('å¯©æ ¸å¤±æ•—', 'error');
          }
        }
      );
    }
    
    // éœ€è¦è£œå……è³‡æ–™
    function requestMore() {
      const notes = document.getElementById('doctorNotes').value.trim();
      
      if (!notes) {
        Utils.showToast('è«‹èªªæ˜éœ€è¦è£œå……çš„å…§å®¹', 'warning');
        return;
      }
      
      Utils.showConfirm(
        'ç¢ºå®šè¦æ±‚æ‚£è€…è£œå……è³‡æ–™å—ï¼Ÿ',
        () => {
          const success = AnalysisManager.reviewAnalysis(
            currentAnalysisId,
            currentUser.id,
            currentUser.name,
            'need_more',
            notes
          );
          
          if (success) {
            const analysis = AnalysisManager.getById(currentAnalysisId);
            NotificationManager.createNotification({
              userId: analysis.userId,
              type: 'review',
              title: 'éœ€è£œå……è³‡æ–™',
              message: `é†«å¸«è¦æ±‚è£œå……è³‡æ–™ï¼š${notes.substring(0, 50)}...`,
              priority: 'high',
              relatedId: currentAnalysisId
            });
            
            Utils.showToast('å·²ç™¼é€è£œå……è¦æ±‚', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            Utils.showToast('æ“ä½œå¤±æ•—', 'error');
          }
        }
      );
    }
    
    // é€€å›æ¡ˆä»¶
    function rejectCase() {
      const notes = document.getElementById('doctorNotes').value.trim();
      
      if (!notes) {
        Utils.showToast('è«‹èªªæ˜é€€å›åŸå› ', 'warning');
        return;
      }
      
      Utils.showConfirm(
        'ç¢ºå®šé€€å›æ­¤æ¡ˆä»¶å—ï¼Ÿ',
        () => {
          const success = AnalysisManager.reviewAnalysis(
            currentAnalysisId,
            currentUser.id,
            currentUser.name,
            'rejected',
            notes
          );
          
          if (success) {
            const analysis = AnalysisManager.getById(currentAnalysisId);
            NotificationManager.createNotification({
              userId: analysis.userId,
              type: 'review',
              title: 'ç—…ä¾‹é€€å›',
              message: `æ‚¨çš„ç—…ä¾‹å·²è¢«é€€å›ã€‚åŸå› ï¼š${notes.substring(0, 50)}...`,
              priority: 'high',
              relatedId: currentAnalysisId
            });
            
            Utils.showToast('å·²é€€å›æ¡ˆä»¶', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            Utils.showToast('æ“ä½œå¤±æ•—', 'error');
          }
        }
      );
    }
    
    // è¿”å›
    function goBack() {
      if (reviewId) {
        window.location.href = 'dashboard.html';
      } else {
        window.history.back();
      }
    }
    
    // åˆå§‹åŒ–é é¢
    initPage();
  </script>
    
    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="bottom-nav">
      <a href="dashboard.html" class="nav-item">
        <div class="nav-icon">ğŸ“Š</div>
        <div>å„€è¡¨æ¿</div>
      </a>
      <a href="review.html" class="nav-item active">
        <div class="nav-icon">ğŸ“‹</div>
        <div>å¯©æ ¸</div>
      </a>
      <a href="patients.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¥</div>
        <div>æ‚£è€…</div>
      </a>
      <a href="doctor-profile.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¨â€âš•ï¸</div>
        <div>æˆ‘çš„</div>
      </a>
    </nav>
  </div>
</body>
</html>
