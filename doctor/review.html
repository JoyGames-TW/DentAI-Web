<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ÂØ©Ê†∏ÁóÖ‰æã - DentAI</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    .patient-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .patient-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .patient-avatar-large {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60A5FA, #3B82F6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .patient-details h2 {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    
    .patient-meta-info {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: #6B7280;
    }
    
    .image-viewer {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .image-canvas {
      width: 100%;
      max-height: 400px;
      border-radius: 8px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    #reviewImage {
      max-width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .image-tools {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      overflow-x: auto;
      padding: 4px 0;
    }
    
    .tool-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid #D1D5DB;
      background: white;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition-fast);
    }
    
    .tool-btn:hover {
      background: #F3F4F6;
    }
    
    .tool-btn.active {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    .ai-analysis-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .risk-display {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: #F9FAFB;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .risk-score {
      text-align: center;
    }
    
    .risk-score-value {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .risk-score-label {
      font-size: 12px;
      color: #6B7280;
      text-transform: uppercase;
    }
    
    .anomaly-item {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .anomaly-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .anomaly-info {
      flex: 1;
    }
    
    .anomaly-name {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 2px;
    }
    
    .anomaly-location {
      font-size: 12px;
      color: #6B7280;
    }
    
    .anomaly-confidence {
      text-align: right;
      font-size: 12px;
      color: #6B7280;
    }
    
    .doctor-notes-section {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .notes-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      font-family: inherit;
    }
    
    .notes-textarea:focus {
      outline: none;
      border-color: #3B82F6;
    }
    
    .quick-notes {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    .quick-note-chip {
      padding: 6px 12px;
      background: #F3F4F6;
      border-radius: 16px;
      font-size: 12px;
      color: #374151;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .quick-note-chip:hover {
      background: #E5E7EB;
    }
    
    .review-actions {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 428px;
      width: 100%;
      background: white;
      border-top: 1px solid #E5E7EB;
      padding: 16px;
      display: flex;
      gap: 12px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      z-index: 100;
    }
    
    .action-button {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .action-button.approve {
      background: #10B981;
      color: white;
    }
    
    .action-button.reject {
      background: #EF4444;
      color: white;
    }
    
    .action-button.request-more {
      background: #F59E0B;
      color: white;
    }
    
    .action-button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .action-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .case-list {
      padding-bottom: 20px;
    }
    
    .filter-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 4px 0;
      margin-bottom: 16px;
    }
    
    .filter-tab {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #D1D5DB;
      background: white;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition-fast);
    }
    
    .filter-tab.active {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    .case-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: var(--transition-fast);
      border-left: 4px solid transparent;
    }
    
    .case-item:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .case-item.high-risk { border-left-color: #EF4444; }
    .case-item.medium-risk { border-left-color: #F59E0B; }
    .case-item.low-risk { border-left-color: #10B981; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- È†ÇÈÉ®Â∞éË¶Ω -->
    <header class="app-header">
      <button class="header-back-btn" onclick="goBack()">‚Üê</button>
      <h1 class="header-title" id="pageTitle">ÁóÖ‰æãÂØ©Ê†∏</h1>
      <div style="width: 44px;"></div>
    </header>
    
    <!-- ÂÖßÂÆπÂçÄÂüü -->
    <div class="app-content">
      <!-- Ê°à‰ª∂ÂàóË°®Ê®°Âºè -->
      <div id="listMode" style="display: none;">
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all" onclick="filterCases('all')">
            ÂÖ®ÈÉ® (<span id="countAll">0</span>)
          </button>
          <button class="filter-tab" data-filter="high" onclick="filterCases('high')">
            È´òÈ¢®Èö™ (<span id="countHigh">0</span>)
          </button>
          <button class="filter-tab" data-filter="medium" onclick="filterCases('medium')">
            ‰∏≠È¢®Èö™ (<span id="countMedium">0</span>)
          </button>
          <button class="filter-tab" data-filter="low" onclick="filterCases('low')">
            ‰ΩéÈ¢®Èö™ (<span id="countLow">0</span>)
          </button>
        </div>
        
        <div class="case-list" id="caseList">
          <!-- ÂãïÊÖãËºâÂÖ•Ê°à‰ª∂ÂàóË°® -->
        </div>
      </div>
      
      <!-- ÂØ©Ê†∏Ê®°Âºè -->
      <div id="reviewMode" style="display: none;">
        <!-- ÊÇ£ËÄÖË≥áË®äÂç° -->
        <div class="patient-card fade-in">
          <div class="patient-header">
            <div class="patient-avatar-large">üë§</div>
            <div class="patient-details">
              <h2 id="patientName">--</h2>
              <div class="patient-meta-info">
                <span id="patientId">ID: --</span>
                <span id="patientAge">Âπ¥ÈΩ°: --</span>
                <span id="uploadTime">--</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ÂΩ±ÂÉèÊ™¢Ë¶ñÂô® -->
        <div class="image-viewer">
          <div class="image-canvas">
            <img id="reviewImage" src="" alt="Âè£ËÖîÂΩ±ÂÉè">
          </div>
          <div class="image-tools">
            <button class="tool-btn" onclick="zoomIn()">üîç ÊîæÂ§ß</button>
            <button class="tool-btn" onclick="zoomOut()">üîç Á∏ÆÂ∞è</button>
            <button class="tool-btn" onclick="resetZoom()">‚Üª ÈáçÁΩÆ</button>
            <button class="tool-btn" id="brightnessBtn" onclick="toggleBrightness()">‚òÄÔ∏è ‰∫ÆÂ∫¶</button>
            <button class="tool-btn" id="contrastBtn" onclick="toggleContrast()">‚óê Â∞çÊØî</button>
          </div>
        </div>
        
        <!-- AI ÂàÜÊûêÁµêÊûú -->
        <div class="ai-analysis-card">
          <div class="section-title">
            <span>ü§ñ</span>
            <span>AI ÂàÜÊûêÁµêÊûú</span>
          </div>
          
          <div class="risk-display">
            <div class="risk-score">
              <div class="risk-score-value" id="riskScoreValue" style="color: #EF4444;">--</div>
              <div class="risk-score-label">È¢®Èö™Ë©ïÂàÜ</div>
            </div>
            <div style="flex: 1; text-align: center;">
              <span class="badge" id="riskBadge" style="font-size: 16px; padding: 8px 16px;">--</span>
            </div>
          </div>
          
          <div class="section-title" style="margin-top: 16px;">
            <span>‚ö†Ô∏è</span>
            <span>Ê™¢Ê∏¨Áï∞Â∏∏ (<span id="anomalyCount">0</span>)</span>
          </div>
          
          <div id="anomalyList">
            <!-- ÂãïÊÖãËºâÂÖ•Áï∞Â∏∏ÂàóË°® -->
          </div>
        </div>
        
        <!-- ÈÜ´Â∏´ÂØ©Ê†∏ÊÑèË¶ã -->
        <div class="doctor-notes-section">
          <div class="section-title">
            <span>üìù</span>
            <span>ÂØ©Ê†∏ÊÑèË¶ã</span>
          </div>
          
          <textarea 
            id="doctorNotes" 
            class="notes-textarea" 
            placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂ∞àÊ•≠ÊÑèË¶ãÂíåÂª∫Ë≠∞..."></textarea>
          
          <div class="quick-notes">
            <div class="quick-note-chip" onclick="addQuickNote('Âª∫Ë≠∞ÈÄ≤Ë°åÈÄ≤‰∏ÄÊ≠•Ê™¢Êü•')">Âª∫Ë≠∞ÈÄ≤‰∏ÄÊ≠•Ê™¢Êü•</div>
            <div class="quick-note-chip" onclick="addQuickNote('ÈúÄË¶ÅÂÆâÊéíÊ≤ªÁôÇ')">ÈúÄË¶ÅÂÆâÊéíÊ≤ªÁôÇ</div>
            <div class="quick-note-chip" onclick="addQuickNote('ÂÆöÊúüËøΩËπ§Âç≥ÂèØ')">ÂÆöÊúüËøΩËπ§Âç≥ÂèØ</div>
            <div class="quick-note-chip" onclick="addQuickNote('Ê≥®ÊÑèÂè£ËÖîË°õÁîü')">Ê≥®ÊÑèÂè£ËÖîË°õÁîü</div>
            <div class="quick-note-chip" onclick="addQuickNote('ÁÑ°ÊòéÈ°ØÁï∞Â∏∏')">ÁÑ°ÊòéÈ°ØÁï∞Â∏∏</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Â∫ïÈÉ®Êìç‰ΩúÊåâÈàï (ÂÉÖÂú®ÂØ©Ê†∏Ê®°ÂºèÈ°ØÁ§∫) -->
    <div class="review-actions" id="reviewActions" style="display: none;">
      <button class="action-button approve" onclick="approveCase()">
        ‚úì ÊâπÂáÜ
      </button>
      <button class="action-button request-more" onclick="requestMore()">
        ‚ö†Ô∏è ÈúÄË£úÂÖÖ
      </button>
      <button class="action-button reject" onclick="rejectCase()">
        ‚úó ÈÄÄÂõû
      </button>
    </div>
    
    <!-- Â∫ïÈÉ®Â∞éË¶Ω -->
    <nav class="bottom-nav">
      <a href="dashboard.html" class="nav-item">
        <div class="nav-icon">üìä</div>
        <div>ÂÑÄË°®Êùø</div>
      </a>
      <a href="review.html" class="nav-item">
        <div class="nav-icon">üìã</div>
        <div>ÂØ©Ê†∏</div>
      </a>
      <a href="patients.html" class="nav-item active">
        <div class="nav-icon">üë•</div>
        <div>ÊÇ£ËÄÖ</div>
      </a>
      <a href="doctor-profile.html" class="nav-item">
        <div class="nav-icon">üë®‚Äç‚öïÔ∏è</div>
        <div>ÊàëÁöÑ</div>
      </a>
    </nav>
  </div>
  
  <script src="../assets/js/storage.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ai-engine.js"></script>
  <script>
    // Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
    if (!UserManager.isLoggedIn()) {
      window.location.href = '../patient/login.html';
    }
    
    const currentUser = UserManager.getCurrentUser();
    let currentAnalysisId = null;
    let currentFilter = 'all';
    let imageZoom = 1;
    let imageBrightness = 100;
    let imageContrast = 100;
    
    // Âæû URL Áç≤ÂèñÂèÉÊï∏
    const urlParams = new URLSearchParams(window.location.search);
    const reviewId = urlParams.get('id');
    const viewMode = urlParams.get('mode');
    
    // ÂàùÂßãÂåñÈ†ÅÈù¢
    function initPage() {
      if (reviewId) {
        // ÂñÆ‰∏ÄÂØ©Ê†∏Ê®°Âºè
        showReviewMode(reviewId);
      } else {
        // Ê°à‰ª∂ÂàóË°®Ê®°Âºè
        showListMode();
      }
    }
    
    // È°ØÁ§∫ÂàóË°®Ê®°Âºè
    function showListMode() {
      document.getElementById('listMode').style.display = 'block';
      document.getElementById('reviewMode').style.display = 'none';
      document.getElementById('reviewActions').style.display = 'none';
      document.getElementById('doctorNav').style.display = 'flex';
      document.getElementById('pageTitle').textContent = 'ÂæÖÂØ©Ê†∏Ê°à‰ª∂';
      
      loadCaseList();
    }
    
    // È°ØÁ§∫ÂØ©Ê†∏Ê®°Âºè
    function showReviewMode(analysisId) {
      document.getElementById('listMode').style.display = 'none';
      document.getElementById('reviewMode').style.display = 'block';
      document.getElementById('reviewActions').style.display = 'flex';
      document.getElementById('doctorNav').style.display = 'none';
      document.getElementById('pageTitle').textContent = 'ÁóÖ‰æãÂØ©Ê†∏';
      
      currentAnalysisId = analysisId;
      loadAnalysisData(analysisId);
    }
    
    // ËºâÂÖ•Ê°à‰ª∂ÂàóË°®
    function loadCaseList() {
      const pendingCases = AnalysisManager.getPendingReviews();
      
      // Êõ¥Êñ∞Ë®àÊï∏
      document.getElementById('countAll').textContent = pendingCases.length;
      document.getElementById('countHigh').textContent = pendingCases.filter(c => c.riskLevel === 'high').length;
      document.getElementById('countMedium').textContent = pendingCases.filter(c => c.riskLevel === 'medium').length;
      document.getElementById('countLow').textContent = pendingCases.filter(c => c.riskLevel === 'low').length;
      
      // È°ØÁ§∫Ê°à‰ª∂
      displayCaseList(pendingCases);
    }
    
    // È°ØÁ§∫Ê°à‰ª∂ÂàóË°®
    function displayCaseList(cases) {
      const container = document.getElementById('caseList');
      
      let filteredCases = cases;
      if (currentFilter !== 'all') {
        filteredCases = cases.filter(c => c.riskLevel === currentFilter);
      }
      
      // ÊåâÈ¢®Èö™Á≠âÁ¥öÂíåÊôÇÈñìÊéíÂ∫è
      filteredCases.sort((a, b) => {
        const riskOrder = { high: 0, medium: 1, low: 2 };
        if (riskOrder[a.riskLevel] !== riskOrder[b.riskLevel]) {
          return riskOrder[a.riskLevel] - riskOrder[b.riskLevel];
        }
        return new Date(b.analyzedAt) - new Date(a.analyzedAt);
      });
      
      if (filteredCases.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #9CA3AF;">
            <div style="font-size: 60px; margin-bottom: 16px;">üìã</div>
            <div style="font-size: 16px; font-weight: 600; color: #374151;">
              Ê≤íÊúâÂæÖÂØ©Ê†∏Ê°à‰ª∂
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredCases.map((caseData, index) => {
        const icons = { high: '‚ö†Ô∏è', medium: '‚ö°', low: '‚úÖ' };
        return `
          <div class="case-item ${caseData.riskLevel}-risk" 
               onclick="viewCase('${caseData.id}')"
               style="animation: slideUp 0.3s ease-out ${index * 0.05}s both;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div>
                <div style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 4px;">
                  ${caseData.userName}
                </div>
                <div style="font-size: 13px; color: #6B7280;">
                  ${Utils.getRelativeTime(caseData.analyzedAt)}
                </div>
              </div>
              <span class="badge badge-${caseData.riskLevel}">
                ${icons[caseData.riskLevel]} ${caseData.riskLevelName}
              </span>
            </div>
            <div style="display: flex; gap: 8px;">
              <div style="background: #F3F4F6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                Ë©ïÂàÜ ${caseData.riskScore}
              </div>
              <div style="background: #F3F4F6; padding: 4px 10px; border-radius: 12px; font-size: 12px;">
                ${caseData.anomalies.length} È†ÖÁï∞Â∏∏
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ÈÅéÊøæÊ°à‰ª∂
    function filterCases(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.filter === filter);
      });
      loadCaseList();
    }
    
    // Êü•ÁúãÊ°à‰ª∂
    function viewCase(analysisId) {
      window.location.href = `review.html?id=${analysisId}`;
    }
    
    // ËºâÂÖ•ÂàÜÊûêÊï∏Êìö
    function loadAnalysisData(analysisId) {
      console.log('ËºâÂÖ•ÂàÜÊûêÊï∏ÊìöÔºåID:', analysisId);
      
      const analysis = AnalysisManager.getById(analysisId);
      console.log('ÂàÜÊûêË®òÈåÑ:', analysis);
      
      if (!analysis) {
        console.error('Êâæ‰∏çÂà∞Ë©≤ÂàÜÊûêË®òÈåÑ');
        Utils.showToast('Êâæ‰∏çÂà∞Ë©≤ÂàÜÊûêË®òÈåÑ', 'error');
        goBack();
        return;
      }
      
      const image = ImageManager.getById(analysis.imageId);
      console.log('ÂΩ±ÂÉèË≥áÊñô:', image);
      
      if (!image) {
        console.error('Êâæ‰∏çÂà∞Áõ∏ÈóúÂΩ±ÂÉè');
        Utils.showToast('Êâæ‰∏çÂà∞Áõ∏ÈóúÂΩ±ÂÉè', 'error');
        goBack();
        return;
      }
      
      // È°ØÁ§∫ÊÇ£ËÄÖË≥áË®ä
      document.getElementById('patientName').textContent = analysis.userName || 'Êú™Áü•ÊÇ£ËÄÖ';
      document.getElementById('patientId').textContent = `ID: ${analysis.userId || '--'}`;
      document.getElementById('uploadTime').textContent = Utils.formatDateTime(analysis.analyzedAt);
      
      // È°ØÁ§∫ÂΩ±ÂÉè
      const reviewImage = document.getElementById('reviewImage');
      reviewImage.src = image.imageData || '';
      reviewImage.onerror = function() {
        console.error('ÂΩ±ÂÉèËºâÂÖ•Â§±Êïó');
        this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect width="400" height="300" fill="%23f3f4f6"/><text x="50%" y="50%" text-anchor="middle" fill="%236b7280" font-size="16">ÂΩ±ÂÉèËºâÂÖ•Â§±Êïó</text></svg>';
      };
      
      // È°ØÁ§∫È¢®Èö™Ë©ïÂàÜ
      const colors = { high: '#EF4444', medium: '#F59E0B', low: '#10B981' };
      const icons = { high: '‚ö†Ô∏è', medium: '‚ö°', low: '‚úÖ' };
      document.getElementById('riskScoreValue').textContent = analysis.riskScore || '--';
      document.getElementById('riskScoreValue').style.color = colors[analysis.riskLevel] || '#6B7280';
      document.getElementById('riskBadge').className = `badge badge-${analysis.riskLevel || 'low'}`;
      document.getElementById('riskBadge').textContent = `${icons[analysis.riskLevel] || '‚úì'} ${analysis.riskLevelName || 'Êú™Áü•'}`;
      
      // È°ØÁ§∫Áï∞Â∏∏ÂàóË°®
      displayAnomalies(analysis.anomalies || []);
      
      // Â¶ÇÊûúÂ∑≤ÊúâÂØ©Ê†∏ÊÑèË¶ãÔºåÈ°ØÁ§∫
      if (analysis.doctorNotes) {
        document.getElementById('doctorNotes').value = analysis.doctorNotes;
      }
      
      console.log('Êï∏ÊìöËºâÂÖ•ÂÆåÊàê');
    }
    
    // È°ØÁ§∫Áï∞Â∏∏ÂàóË°®
    function displayAnomalies(anomalies) {
      document.getElementById('anomalyCount').textContent = anomalies.length;
      
      const container = document.getElementById('anomalyList');
      
      if (anomalies.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #9CA3AF; font-size: 14px;">
            Êú™Ê™¢Ê∏¨Âà∞ÊòéÈ°ØÁï∞Â∏∏
          </div>
        `;
        return;
      }
      
      const anomalyConfig = {
        caries: { name: 'ÈΩ≤ÈΩí', icon: 'ü¶∑', color: '#FEE2E2' },
        calculus: { name: 'ÁâôÁµêÁü≥', icon: 'üíé', color: '#FEF3C7' },
        gingivitis: { name: 'ÁâôÈΩ¶ÁÇé', icon: 'üî¥', color: '#FECACA' },
        stain: { name: 'Ëâ≤Á¥†Ê≤âËëó', icon: 'üü§', color: '#FDE68A' },
        recession: { name: 'ÁâôÈΩ¶ËêéÁ∏Æ', icon: 'üìâ', color: '#DBEAFE' }
      };
      
      container.innerHTML = anomalies.map(anomaly => {
        const config = anomalyConfig[anomaly.type] || { name: anomaly.type, icon: '‚ö†Ô∏è', color: '#E5E7EB' };
        return `
          <div class="anomaly-item">
            <div class="anomaly-icon" style="background: ${config.color};">
              ${config.icon}
            </div>
            <div class="anomaly-info">
              <div class="anomaly-name">${config.name}</div>
              <div class="anomaly-location">${anomaly.location}</div>
            </div>
            <div class="anomaly-confidence">
              ‰ø°ÂøÉÂ∫¶<br>
              <strong>${anomaly.confidence}%</strong>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ÂΩ±ÂÉèÊéßÂà∂ÂäüËÉΩ
    function zoomIn() {
      imageZoom = Math.min(imageZoom + 0.2, 3);
      applyImageFilters();
    }
    
    function zoomOut() {
      imageZoom = Math.max(imageZoom - 0.2, 0.5);
      applyImageFilters();
    }
    
    function resetZoom() {
      imageZoom = 1;
      imageBrightness = 100;
      imageContrast = 100;
      applyImageFilters();
      document.getElementById('brightnessBtn').classList.remove('active');
      document.getElementById('contrastBtn').classList.remove('active');
    }
    
    function toggleBrightness() {
      const btn = document.getElementById('brightnessBtn');
      if (btn.classList.contains('active')) {
        imageBrightness = 100;
        btn.classList.remove('active');
      } else {
        imageBrightness = 120;
        btn.classList.add('active');
      }
      applyImageFilters();
    }
    
    function toggleContrast() {
      const btn = document.getElementById('contrastBtn');
      if (btn.classList.contains('active')) {
        imageContrast = 100;
        btn.classList.remove('active');
      } else {
        imageContrast = 120;
        btn.classList.add('active');
      }
      applyImageFilters();
    }
    
    function applyImageFilters() {
      const img = document.getElementById('reviewImage');
      img.style.transform = `scale(${imageZoom})`;
      img.style.filter = `brightness(${imageBrightness}%) contrast(${imageContrast}%)`;
    }
    
    // Âø´ÈÄüÁ≠ÜË®ò
    function addQuickNote(text) {
      const textarea = document.getElementById('doctorNotes');
      const currentValue = textarea.value.trim();
      if (currentValue) {
        textarea.value = currentValue + '\n' + text;
      } else {
        textarea.value = text;
      }
    }
    
    // ÊâπÂáÜÊ°à‰ª∂
    function approveCase() {
      const notes = document.getElementById('doctorNotes').value.trim();
      
      if (!notes) {
        Utils.showToast('Ë´ãËº∏ÂÖ•ÂØ©Ê†∏ÊÑèË¶ã', 'warning');
        return;
      }
      
      Utils.showConfirm(
        'Á¢∫ÂÆöÊâπÂáÜÊ≠§Ê°à‰ª∂ÂóéÔºü',
        () => {
          const success = AnalysisManager.reviewAnalysis(
            currentAnalysisId,
            currentUser.id,
            currentUser.name,
            'approved',
            notes
          );
          
          if (success) {
            // ÁôºÈÄÅÈÄöÁü•Áµ¶ÊÇ£ËÄÖ
            const analysis = AnalysisManager.getById(currentAnalysisId);
            NotificationManager.createNotification({
              userId: analysis.userId,
              type: 'review',
              title: 'ÁóÖ‰æãÂØ©Ê†∏ÂÆåÊàê',
              message: `ÊÇ®ÁöÑÂè£ËÖîÂΩ±ÂÉèÂ∑≤ÈÄöÈÅéÂØ©Ê†∏„ÄÇÈÜ´Â∏´ÊÑèË¶ãÔºö${notes.substring(0, 50)}...`,
              priority: 'high',
              relatedId: currentAnalysisId
            });
            
            Utils.showToast('ÂØ©Ê†∏ÂÆåÊàê', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            Utils.showToast('ÂØ©Ê†∏Â§±Êïó', 'error');
          }
        }
      );
    }
    
    // ÈúÄË¶ÅË£úÂÖÖË≥áÊñô
    function requestMore() {
      const notes = document.getElementById('doctorNotes').value.trim();
      
      if (!notes) {
        Utils.showToast('Ë´ãË™™ÊòéÈúÄË¶ÅË£úÂÖÖÁöÑÂÖßÂÆπ', 'warning');
        return;
      }
      
      Utils.showConfirm(
        'Á¢∫ÂÆöË¶ÅÊ±ÇÊÇ£ËÄÖË£úÂÖÖË≥áÊñôÂóéÔºü',
        () => {
          const success = AnalysisManager.reviewAnalysis(
            currentAnalysisId,
            currentUser.id,
            currentUser.name,
            'need_more',
            notes
          );
          
          if (success) {
            const analysis = AnalysisManager.getById(currentAnalysisId);
            NotificationManager.createNotification({
              userId: analysis.userId,
              type: 'review',
              title: 'ÈúÄË£úÂÖÖË≥áÊñô',
              message: `ÈÜ´Â∏´Ë¶ÅÊ±ÇË£úÂÖÖË≥áÊñôÔºö${notes.substring(0, 50)}...`,
              priority: 'high',
              relatedId: currentAnalysisId
            });
            
            Utils.showToast('Â∑≤ÁôºÈÄÅË£úÂÖÖË¶ÅÊ±Ç', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            Utils.showToast('Êìç‰ΩúÂ§±Êïó', 'error');
          }
        }
      );
    }
    
    // ÈÄÄÂõûÊ°à‰ª∂
    function rejectCase() {
      const notes = document.getElementById('doctorNotes').value.trim();
      
      if (!notes) {
        Utils.showToast('Ë´ãË™™ÊòéÈÄÄÂõûÂéüÂõ†', 'warning');
        return;
      }
      
      Utils.showConfirm(
        'Á¢∫ÂÆöÈÄÄÂõûÊ≠§Ê°à‰ª∂ÂóéÔºü',
        () => {
          const success = AnalysisManager.reviewAnalysis(
            currentAnalysisId,
            currentUser.id,
            currentUser.name,
            'rejected',
            notes
          );
          
          if (success) {
            const analysis = AnalysisManager.getById(currentAnalysisId);
            NotificationManager.createNotification({
              userId: analysis.userId,
              type: 'review',
              title: 'ÁóÖ‰æãÈÄÄÂõû',
              message: `ÊÇ®ÁöÑÁóÖ‰æãÂ∑≤Ë¢´ÈÄÄÂõû„ÄÇÂéüÂõ†Ôºö${notes.substring(0, 50)}...`,
              priority: 'high',
              relatedId: currentAnalysisId
            });
            
            Utils.showToast('Â∑≤ÈÄÄÂõûÊ°à‰ª∂', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            Utils.showToast('Êìç‰ΩúÂ§±Êïó', 'error');
          }
        }
      );
    }
    
    // ËøîÂõû
    function goBack() {
      if (reviewId) {
        window.location.href = 'dashboard.html';
      } else {
        window.history.back();
      }
    }
    
    // ÂàùÂßãÂåñÈ†ÅÈù¢
    initPage();
  </script>
    
    <!-- Â∫ïÈÉ®Â∞éË¶Ω -->
    <nav class="bottom-nav">
      <a href="dashboard.html" class="nav-item">
        <div class="nav-icon">üìä</div>
        <div>ÂÑÄË°®Êùø</div>
      </a>
      <a href="review.html" class="nav-item active">
        <div class="nav-icon">üìã</div>
        <div>ÂØ©Ê†∏</div>
      </a>
      <a href="patients.html" class="nav-item">
        <div class="nav-icon">üë•</div>
        <div>ÊÇ£ËÄÖ</div>
      </a>
      <a href="doctor-profile.html" class="nav-item">
        <div class="nav-icon">üë®‚Äç‚öïÔ∏è</div>
        <div>ÊàëÁöÑ</div>
      </a>
    </nav>
  </div>
</body>
</html>
