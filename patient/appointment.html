<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é ç´„çœ‹è¨º - DentAI æ™ºæ…§å£è…”å¥åº·ç›£æ¸¬</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
    .step-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
      padding: 20px 16px;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      border-radius: 12px;
      color: white;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .step.active .step-number {
      background: white;
      color: #3B82F6;
    }
    
    .step-label {
      font-size: 14px;
      font-weight: 500;
    }
    
    .step-arrow {
      font-size: 18px;
      opacity: 0.5;
    }
    
    /* æ—¥æœŸé¸æ“‡å™¨ */
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-picker {
      overflow-x: auto;
      margin-bottom: 32px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .date-picker::-webkit-scrollbar {
      display: none;
    }
    
    .date-list {
      display: flex;
      gap: 12px;
      padding: 4px 0;
    }
    
    .date-card {
      flex-shrink: 0;
      width: 80px;
      padding: 16px 12px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-card:hover {
      border-color: #3B82F6;
      transform: translateY(-2px);
    }
    
    .date-card.active {
      border-color: #3B82F6;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
    }
    
    .date-weekday {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 4px;
    }
    
    .date-day {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 2px;
    }
    
    .date-month {
      font-size: 12px;
      opacity: 0.7;
    }
    
    /* æ™‚æ®µåˆ—è¡¨ */
    .time-slots {
      margin-bottom: 32px;
    }
    
    .doctor-group {
      margin-bottom: 24px;
      padding: 20px;
      background: #F9FAFB;
      border-radius: 16px;
    }
    
    .doctor-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .doctor-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: 600;
    }
    
    .doctor-details {
      flex: 1;
    }
    
    .doctor-name {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    
    .doctor-specialty {
      font-size: 13px;
      color: #6B7280;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .time-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .time-slot {
      padding: 12px 8px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .time-slot:hover:not(.booked) {
      border-color: #3B82F6;
      background: #EFF6FF;
    }
    
    .time-slot.selected {
      border-color: #3B82F6;
      background: #3B82F6;
      color: white;
    }
    
    .time-slot.booked {
      background: #F3F4F6;
      color: #9CA3AF;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    /* ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 16px;
      color: #6B7280;
    }
    
    /* ç¢ºèªæŒ‰éˆ• */
    .confirm-button {
      width: 100%;
      margin-top: 24px;
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: all 0.2s;
    }
    
    .confirm-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }
    
    .confirm-button:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* ç¢ºèªå°è©±æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 340px;
      width: calc(100% - 40px);
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      text-align: center;
      margin-bottom: 8px;
    }
    
    .modal-message {
      font-size: 14px;
      color: #6B7280;
      text-align: center;
      margin-bottom: 24px;
      line-height: 1.6;
    }
    
    .modal-details {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }
    
    .modal-detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }
    
    .modal-detail-item:not(:last-child) {
      border-bottom: 1px solid #E5E7EB;
    }
    
    .modal-detail-label {
      font-size: 14px;
      color: #6B7280;
    }
    
    .modal-detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn-secondary {
      background: #F3F4F6;
      color: #6B7280;
    }
    
    .modal-btn-secondary:hover {
      background: #E5E7EB;
    }
    
    .modal-btn-primary {
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
    }
    
    .modal-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    /* è¼‰å…¥ç‹€æ…‹ */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #E5E7EB;
      border-top-color: #3B82F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 14px;
      color: #6B7280;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é ‚éƒ¨å°è¦½ -->
    <header class="app-header">
      <button class="header-back-btn" onclick="goBack()">â†</button>
      <h1 class="header-title">é ç´„çœ‹è¨º</h1>
    </header>
    
    <!-- å…§å®¹å€åŸŸ -->
    <div class="app-content">
      <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
      <div class="step-indicator">
        <div class="step active">
          <div class="step-number">1</div>
          <div class="step-label">é¸æ“‡æ—¥æœŸ</div>
        </div>
        <div class="step-arrow">â†’</div>
        <div class="step" id="step2">
          <div class="step-number">2</div>
          <div class="step-label">é¸æ“‡æ™‚æ®µ</div>
        </div>
      </div>
      
      <!-- è¼‰å…¥ç‹€æ…‹ -->
      <div id="loadingState" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">è¼‰å…¥ä¸­...</div>
      </div>
      
      <!-- æ—¥æœŸé¸æ“‡ -->
      <div id="dateSection">
        <div class="section-title">
          ğŸ“… é¸æ“‡æ—¥æœŸ
        </div>
        <div class="date-picker">
          <div class="date-list" id="dateList">
            <!-- å‹•æ…‹è¼‰å…¥ -->
          </div>
        </div>
      </div>
      
      <!-- æ™‚æ®µåˆ—è¡¨ -->
      <div id="timeSection" style="display: none;">
        <div class="section-title">
          â° é¸æ“‡æ™‚æ®µ
        </div>
        <div class="time-slots" id="timeSlots">
          <!-- å‹•æ…‹è¼‰å…¥ -->
        </div>
      </div>
      
      <!-- ç©ºç‹€æ…‹ -->
      <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">ğŸ“­</div>
        <div class="empty-state-text">æ­¤æ—¥æœŸæš«ç„¡å¯é ç´„æ™‚æ®µ</div>
      </div>
      
      <!-- ç¢ºèªæŒ‰éˆ• -->
      <button id="confirmBtn" class="confirm-button" disabled onclick="confirmBooking()">
        ç¢ºèªé ç´„
      </button>
    </div>
    
    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="bottom-nav">
      <a href="home.html" class="nav-item">
        <div class="nav-icon">ğŸ </div>
        <div>é¦–é </div>
      </a>
      <a href="upload.html" class="nav-item">
        <div class="nav-icon">ï¿½</div>
        <div>æª¢æ¸¬</div>
      </a>
      <a href="history.html" class="nav-item">
        <div class="nav-icon">ğŸ“Š</div>
        <div>ç´€éŒ„</div>
      </a>
      <a href="profile.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>æˆ‘çš„</div>
      </a>
    </nav>
  </div>
  
  <!-- ç¢ºèªå°è©±æ¡† -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-icon">âœ…</div>
      <div class="modal-title">ç¢ºèªé ç´„è³‡è¨Š</div>
      <div class="modal-message">è«‹ç¢ºèªä»¥ä¸‹é ç´„è³‡è¨Šæ˜¯å¦æ­£ç¢º</div>
      <div class="modal-details">
        <div class="modal-detail-item">
          <div class="modal-detail-label">æ—¥æœŸ</div>
          <div class="modal-detail-value" id="modalDate">-</div>
        </div>
        <div class="modal-detail-item">
          <div class="modal-detail-label">æ™‚é–“</div>
          <div class="modal-detail-value" id="modalTime">-</div>
        </div>
        <div class="modal-detail-item">
          <div class="modal-detail-label">é†«å¸«</div>
          <div class="modal-detail-value" id="modalDoctor">-</div>
        </div>
        <div class="modal-detail-item">
          <div class="modal-detail-label">è¨ºæ‰€</div>
          <div class="modal-detail-value" id="modalHospital">-</div>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="modal-btn modal-btn-primary" onclick="submitBooking()">ç¢ºèªé ç´„</button>
      </div>
    </div>
  </div>
  
  <script src="../assets/js/storage.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script>
    let selectedDate = null;
    let selectedSlot = null;
    
    // åˆå§‹åŒ–
    async function init() {
      // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const currentUser = UserManager.getCurrentUser();
      if (!currentUser) {
        window.location.href = '../index.html';
        return;
      }
      
      // åˆå§‹åŒ–é ç´„ç³»çµ±
      AppointmentManager.init();
      
      // è¼‰å…¥æ—¥æœŸåˆ—è¡¨
      loadDates();
    }
    
    // è¼‰å…¥å¯é ç´„æ—¥æœŸ
    function loadDates() {
      const dates = AppointmentManager.getAvailableDates();
      const dateList = document.getElementById('dateList');
      
      if (dates.length === 0) {
        dateList.innerHTML = '<div class="empty-state"><div class="empty-state-text">æš«ç„¡å¯é ç´„æ—¥æœŸ</div></div>';
        return;
      }
      
      dateList.innerHTML = dates.map(dateStr => {
        const date = new Date(dateStr);
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekday = weekdays[date.getDay()];
        const day = date.getDate();
        const month = date.getMonth() + 1;
        
        return `
          <div class="date-card" onclick="selectDate('${dateStr}')">
            <div class="date-weekday">é€±${weekday}</div>
            <div class="date-day">${day}</div>
            <div class="date-month">${month}æœˆ</div>
          </div>
        `;
      }).join('');
    }
    
    // é¸æ“‡æ—¥æœŸ
    function selectDate(dateStr) {
      selectedDate = dateStr;
      selectedSlot = null;
      
      // æ›´æ–°æ—¥æœŸå¡ç‰‡æ¨£å¼
      document.querySelectorAll('.date-card').forEach(card => {
        card.classList.remove('active');
      });
      event.target.closest('.date-card').classList.add('active');
      
      // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
      document.getElementById('step2').classList.add('active');
      
      // è¼‰å…¥æ™‚æ®µ
      loadTimeSlots(dateStr);
      
      // é¡¯ç¤ºæ™‚æ®µå€åŸŸ
      document.getElementById('timeSection').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      
      // æ»¾å‹•åˆ°æ™‚æ®µå€åŸŸ
      setTimeout(() => {
        document.getElementById('timeSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }
    
    // è¼‰å…¥æ™‚æ®µ
    function loadTimeSlots(dateStr) {
      const slots = AppointmentManager.getAvailableSlots(dateStr);
      const timeSlots = document.getElementById('timeSlots');
      
      if (slots.length === 0) {
        document.getElementById('timeSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }
      
      // æŒ‰é†«ç”Ÿåˆ†çµ„
      const groupedByDoctor = slots.reduce((acc, slot) => {
        if (!acc[slot.doctorId]) {
          acc[slot.doctorId] = {
            doctor: {
              id: slot.doctorId,
              name: slot.doctorName,
              specialty: slot.doctorSpecialty,
              hospital: slot.hospital
            },
            slots: []
          };
        }
        acc[slot.doctorId].slots.push(slot);
        return acc;
      }, {});
      
      // æ¸²æŸ“é†«ç”Ÿæ™‚æ®µçµ„
      timeSlots.innerHTML = Object.values(groupedByDoctor).map(group => {
        const doctorInitial = group.doctor.name.charAt(0);
        
        return `
          <div class="doctor-group">
            <div class="doctor-info">
              <div class="doctor-avatar">${doctorInitial}</div>
              <div class="doctor-details">
                <div class="doctor-name">${group.doctor.name}</div>
                <div class="doctor-specialty">
                  ğŸ¥ ${group.doctor.specialty} | ${group.doctor.hospital}
                </div>
              </div>
            </div>
            <div class="time-grid">
              ${group.slots.map(slot => `
                <div class="time-slot ${slot.isBooked ? 'booked' : ''}" 
                     data-slot-id="${slot.id}"
                     onclick="${slot.isBooked ? '' : `selectSlot('${slot.id}')`}">
                  ${slot.time}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      // ç¦ç”¨ç¢ºèªæŒ‰éˆ•
      document.getElementById('confirmBtn').disabled = true;
    }
    
    // é¸æ“‡æ™‚æ®µ
    function selectSlot(slotId) {
      const slots = StorageManager.get(StorageManager.KEYS.APPOINTMENT_SLOTS) || [];
      selectedSlot = slots.find(s => s.id === slotId);
      
      if (!selectedSlot || selectedSlot.isBooked) {
        return;
      }
      
      // æ›´æ–°æ™‚æ®µå¡ç‰‡æ¨£å¼
      document.querySelectorAll('.time-slot').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-slot-id="${slotId}"]`).classList.add('selected');
      
      // å•Ÿç”¨ç¢ºèªæŒ‰éˆ•
      document.getElementById('confirmBtn').disabled = false;
    }
    
    // ç¢ºèªé ç´„ï¼ˆé¡¯ç¤ºå°è©±æ¡†ï¼‰
    function confirmBooking() {
      if (!selectedSlot) {
        return;
      }
      
      // å¡«å……å°è©±æ¡†è³‡è¨Š
      const date = new Date(selectedSlot.date);
      const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      const weekday = weekdays[date.getDay()];
      
      document.getElementById('modalDate').textContent = `${dateStr} (é€±${weekday})`;
      document.getElementById('modalTime').textContent = selectedSlot.time;
      document.getElementById('modalDoctor').textContent = selectedSlot.doctorName;
      document.getElementById('modalHospital').textContent = selectedSlot.hospital;
      
      // é¡¯ç¤ºå°è©±æ¡†
      document.getElementById('confirmModal').classList.add('show');
    }
    
    // é—œé–‰å°è©±æ¡†
    function closeModal() {
      document.getElementById('confirmModal').classList.remove('show');
    }
    
    // æäº¤é ç´„
    async function submitBooking() {
      if (!selectedSlot) {
        return;
      }
      
      const currentUser = UserManager.getCurrentUser();
      
      try {
        // åŸ·è¡Œé ç´„
        const appointment = AppointmentManager.bookAppointment(selectedSlot.id, currentUser.id);
        
        // é—œé–‰å°è©±æ¡†
        closeModal();
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        Utils.showToast('é ç´„æˆåŠŸï¼', 'success');
        
        // å»¶é²è·³è½‰
        await Utils.sleep(1500);
        window.location.href = 'dashboard.html';
        
      } catch (error) {
        console.error('é ç´„å¤±æ•—:', error);
        Utils.showToast(error.message || 'é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        closeModal();
      }
    }
    
    // è¿”å›
    function goBack() {
      window.history.back();
    }
    
    // é é¢è¼‰å…¥
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
