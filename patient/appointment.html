<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>È†êÁ¥ÑÁúãË®∫ - DentAI Êô∫ÊÖßÂè£ËÖîÂÅ•Â∫∑Áõ£Ê∏¨</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    /* Ê≠•È©üÊåáÁ§∫Âô® */
    .step-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
      padding: 20px 16px;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      border-radius: 12px;
      color: white;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .step.active .step-number {
      background: white;
      color: #3B82F6;
    }
    
    .step-label {
      font-size: 14px;
      font-weight: 500;
    }
    
    .step-arrow {
      font-size: 18px;
      opacity: 0.5;
    }
    
    /* Êó•ÊúüÈÅ∏ÊìáÂô® */
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-picker {
      overflow-x: auto;
      margin-bottom: 32px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .date-picker::-webkit-scrollbar {
      display: none;
    }
    
    .date-list {
      display: flex;
      gap: 12px;
      padding: 4px 0;
    }
    
    .date-card {
      flex-shrink: 0;
      width: 80px;
      padding: 16px 12px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .date-card:hover {
      border-color: #3B82F6;
      transform: translateY(-2px);
    }
    
    .date-card.active {
      border-color: #3B82F6;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
    }
    
    .date-weekday {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 4px;
    }
    
    .date-day {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 2px;
    }
    
    .date-month {
      font-size: 12px;
      opacity: 0.7;
    }
    
    /* ÊôÇÊÆµÂàóË°® */
    .time-slots {
      margin-bottom: 32px;
    }
    
    .doctor-group {
      margin-bottom: 24px;
      padding: 20px;
      background: #F9FAFB;
      border-radius: 16px;
    }
    
    .doctor-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .doctor-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: 600;
    }
    
    .doctor-details {
      flex: 1;
    }
    
    .doctor-name {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    
    .doctor-specialty {
      font-size: 13px;
      color: #6B7280;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .time-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .time-slot {
      padding: 12px 8px;
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .time-slot:hover:not(.booked) {
      border-color: #3B82F6;
      background: #EFF6FF;
    }
    
    .time-slot.selected {
      border-color: #3B82F6;
      background: #3B82F6;
      color: white;
    }
    
    .time-slot.booked {
      background: #F3F4F6;
      color: #9CA3AF;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    /* Á©∫ÁãÄÊÖã */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 16px;
      color: #6B7280;
    }
    
    /* Á¢∫Ë™çÊåâÈàï */
    .confirm-button {
      width: 100%;
      margin-top: 24px;
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transition: all 0.2s;
    }
    
    .confirm-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }
    
    .confirm-button:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    /* Á¢∫Ë™çÂ∞çË©±Ê°Ü */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 340px;
      width: calc(100% - 40px);
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      text-align: center;
      margin-bottom: 8px;
    }
    
    .modal-message {
      font-size: 14px;
      color: #6B7280;
      text-align: center;
      margin-bottom: 24px;
      line-height: 1.6;
    }
    
    .modal-details {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }
    
    .modal-detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }
    
    .modal-detail-item:not(:last-child) {
      border-bottom: 1px solid #E5E7EB;
    }
    
    .modal-detail-label {
      font-size: 14px;
      color: #6B7280;
    }
    
    .modal-detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn-secondary {
      background: #F3F4F6;
      color: #6B7280;
    }
    
    .modal-btn-secondary:hover {
      background: #E5E7EB;
    }
    
    .modal-btn-primary {
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      color: white;
    }
    
    .modal-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    /* ËºâÂÖ•ÁãÄÊÖã */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #E5E7EB;
      border-top-color: #3B82F6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 14px;
      color: #6B7280;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- È†ÇÈÉ®Â∞éË¶Ω -->
    <header class="app-header">
      <button class="header-back-btn" onclick="goBack()">‚Üê</button>
      <h1 class="header-title">È†êÁ¥ÑÁúãË®∫</h1>
    </header>
    
    <!-- ÂÖßÂÆπÂçÄÂüü -->
    <div class="app-content">
      <!-- Ê≠•È©üÊåáÁ§∫Âô® -->
      <div class="step-indicator">
        <div class="step active">
          <div class="step-number">1</div>
          <div class="step-label">ÈÅ∏ÊìáÊó•Êúü</div>
        </div>
        <div class="step-arrow">‚Üí</div>
        <div class="step" id="step2">
          <div class="step-number">2</div>
          <div class="step-label">ÈÅ∏ÊìáÊôÇÊÆµ</div>
        </div>
      </div>
      
      <!-- ËºâÂÖ•ÁãÄÊÖã -->
      <div id="loadingState" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div class="loading-text">ËºâÂÖ•‰∏≠...</div>
      </div>
      
      <!-- Êó•ÊúüÈÅ∏Êìá -->
      <div id="dateSection">
        <div class="section-title">
          üìÖ ÈÅ∏ÊìáÊó•Êúü
        </div>
        <div class="date-picker">
          <div class="date-list" id="dateList">
            <!-- ÂãïÊÖãËºâÂÖ• -->
          </div>
        </div>
      </div>
      
      <!-- ÊôÇÊÆµÂàóË°® -->
      <div id="timeSection" style="display: none;">
        <div class="section-title">
          ‚è∞ ÈÅ∏ÊìáÊôÇÊÆµ
        </div>
        <div class="time-slots" id="timeSlots">
          <!-- ÂãïÊÖãËºâÂÖ• -->
        </div>
      </div>
      
      <!-- Á©∫ÁãÄÊÖã -->
      <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üì≠</div>
        <div class="empty-state-text">Ê≠§Êó•ÊúüÊö´ÁÑ°ÂèØÈ†êÁ¥ÑÊôÇÊÆµ</div>
      </div>
      
      <!-- Á¢∫Ë™çÊåâÈàï -->
      <button id="confirmBtn" class="confirm-button" disabled onclick="confirmBooking()">
        Á¢∫Ë™çÈ†êÁ¥Ñ
      </button>
    </div>
    
    <!-- Â∫ïÈÉ®Â∞éË¶Ω -->
    <nav class="bottom-nav">
      <a href="home.html" class="nav-item">
        <div class="nav-icon">üè†</div>
        <div>È¶ñÈ†Å</div>
      </a>
      <a href="upload.html" class="nav-item">
        <div class="nav-icon">ÔøΩ</div>
        <div>Ê™¢Ê∏¨</div>
      </a>
      <a href="history.html" class="nav-item">
        <div class="nav-icon">üìä</div>
        <div>Á¥ÄÈåÑ</div>
      </a>
      <a href="profile.html" class="nav-item">
        <div class="nav-icon">üë§</div>
        <div>ÊàëÁöÑ</div>
      </a>
    </nav>
  </div>
  
  <!-- Á¢∫Ë™çÂ∞çË©±Ê°Ü -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-icon">‚úÖ</div>
      <div class="modal-title">Á¢∫Ë™çÈ†êÁ¥ÑË≥áË®ä</div>
      <div class="modal-message">Ë´ãÁ¢∫Ë™ç‰ª•‰∏ãÈ†êÁ¥ÑË≥áË®äÊòØÂê¶Ê≠£Á¢∫</div>
      <div class="modal-details">
        <div class="modal-detail-item">
          <div class="modal-detail-label">Êó•Êúü</div>
          <div class="modal-detail-value" id="modalDate">-</div>
        </div>
        <div class="modal-detail-item">
          <div class="modal-detail-label">ÊôÇÈñì</div>
          <div class="modal-detail-value" id="modalTime">-</div>
        </div>
        <div class="modal-detail-item">
          <div class="modal-detail-label">ÈÜ´Â∏´</div>
          <div class="modal-detail-value" id="modalDoctor">-</div>
        </div>
        <div class="modal-detail-item">
          <div class="modal-detail-label">Ë®∫ÊâÄ</div>
          <div class="modal-detail-value" id="modalHospital">-</div>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
        <button class="modal-btn modal-btn-primary" onclick="submitBooking()">Á¢∫Ë™çÈ†êÁ¥Ñ</button>
      </div>
    </div>
  </div>
  
  <script src="../assets/js/storage.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script>
    let selectedDate = null;
    let selectedSlot = null;
    
    // ÂàùÂßãÂåñ
    async function init() {
      // Ê™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
      const currentUser = UserManager.getCurrentUser();
      if (!currentUser) {
        window.location.href = '../index.html';
        return;
      }
      
      // ÂàùÂßãÂåñÈ†êÁ¥ÑÁ≥ªÁµ±
      AppointmentManager.init();
      
      // ËºâÂÖ•Êó•ÊúüÂàóË°®
      loadDates();
    }
    
    // ËºâÂÖ•ÂèØÈ†êÁ¥ÑÊó•Êúü
    function loadDates() {
      const dates = AppointmentManager.getAvailableDates();
      const dateList = document.getElementById('dateList');
      
      if (dates.length === 0) {
        dateList.innerHTML = '<div class="empty-state"><div class="empty-state-text">Êö´ÁÑ°ÂèØÈ†êÁ¥ÑÊó•Êúü</div></div>';
        return;
      }
      
      dateList.innerHTML = dates.map(dateStr => {
        const date = new Date(dateStr);
        const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        const weekday = weekdays[date.getDay()];
        const day = date.getDate();
        const month = date.getMonth() + 1;
        
        return `
          <div class="date-card" onclick="selectDate('${dateStr}')">
            <div class="date-weekday">ÈÄ±${weekday}</div>
            <div class="date-day">${day}</div>
            <div class="date-month">${month}Êúà</div>
          </div>
        `;
      }).join('');
    }
    
    // ÈÅ∏ÊìáÊó•Êúü
    function selectDate(dateStr) {
      selectedDate = dateStr;
      selectedSlot = null;
      
      // Êõ¥Êñ∞Êó•ÊúüÂç°ÁâáÊ®£Âºè
      document.querySelectorAll('.date-card').forEach(card => {
        card.classList.remove('active');
      });
      event.target.closest('.date-card').classList.add('active');
      
      // Êõ¥Êñ∞Ê≠•È©üÊåáÁ§∫Âô®
      document.getElementById('step2').classList.add('active');
      
      // ËºâÂÖ•ÊôÇÊÆµ
      loadTimeSlots(dateStr);
      
      // È°ØÁ§∫ÊôÇÊÆµÂçÄÂüü
      document.getElementById('timeSection').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      
      // ÊªæÂãïÂà∞ÊôÇÊÆµÂçÄÂüü
      setTimeout(() => {
        document.getElementById('timeSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }
    
    // ËºâÂÖ•ÊôÇÊÆµ
    function loadTimeSlots(dateStr) {
      const slots = AppointmentManager.getAvailableSlots(dateStr);
      const timeSlots = document.getElementById('timeSlots');
      
      if (slots.length === 0) {
        document.getElementById('timeSection').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }
      
      // ÊåâÈÜ´ÁîüÂàÜÁµÑ
      const groupedByDoctor = slots.reduce((acc, slot) => {
        if (!acc[slot.doctorId]) {
          acc[slot.doctorId] = {
            doctor: {
              id: slot.doctorId,
              name: slot.doctorName,
              specialty: slot.doctorSpecialty,
              hospital: slot.hospital
            },
            slots: []
          };
        }
        acc[slot.doctorId].slots.push(slot);
        return acc;
      }, {});
      
      // Ê∏≤ÊüìÈÜ´ÁîüÊôÇÊÆµÁµÑ
      timeSlots.innerHTML = Object.values(groupedByDoctor).map(group => {
        const doctorInitial = group.doctor.name.charAt(0);
        
        return `
          <div class="doctor-group">
            <div class="doctor-info">
              <div class="doctor-avatar">${doctorInitial}</div>
              <div class="doctor-details">
                <div class="doctor-name">${group.doctor.name}</div>
                <div class="doctor-specialty">
                  üè• ${group.doctor.specialty} | ${group.doctor.hospital}
                </div>
              </div>
            </div>
            <div class="time-grid">
              ${group.slots.map(slot => `
                <div class="time-slot ${slot.isBooked ? 'booked' : ''}" 
                     data-slot-id="${slot.id}"
                     onclick="${slot.isBooked ? '' : `selectSlot('${slot.id}')`}">
                  ${slot.time}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
      
      // Á¶ÅÁî®Á¢∫Ë™çÊåâÈàï
      document.getElementById('confirmBtn').disabled = true;
    }
    
    // ÈÅ∏ÊìáÊôÇÊÆµ
    function selectSlot(slotId) {
      const slots = StorageManager.get(StorageManager.KEYS.APPOINTMENT_SLOTS) || [];
      selectedSlot = slots.find(s => s.id === slotId);
      
      if (!selectedSlot || selectedSlot.isBooked) {
        return;
      }
      
      // Êõ¥Êñ∞ÊôÇÊÆµÂç°ÁâáÊ®£Âºè
      document.querySelectorAll('.time-slot').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`[data-slot-id="${slotId}"]`).classList.add('selected');
      
      // ÂïüÁî®Á¢∫Ë™çÊåâÈàï
      document.getElementById('confirmBtn').disabled = false;
    }
    
    // Á¢∫Ë™çÈ†êÁ¥ÑÔºàÈ°ØÁ§∫Â∞çË©±Ê°ÜÔºâ
    function confirmBooking() {
      if (!selectedSlot) {
        return;
      }
      
      // Â°´ÂÖÖÂ∞çË©±Ê°ÜË≥áË®ä
      const date = new Date(selectedSlot.date);
      const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
      const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
      const weekday = weekdays[date.getDay()];
      
      document.getElementById('modalDate').textContent = `${dateStr} (ÈÄ±${weekday})`;
      document.getElementById('modalTime').textContent = selectedSlot.time;
      document.getElementById('modalDoctor').textContent = selectedSlot.doctorName;
      document.getElementById('modalHospital').textContent = selectedSlot.hospital;
      
      // È°ØÁ§∫Â∞çË©±Ê°Ü
      document.getElementById('confirmModal').classList.add('show');
    }
    
    // ÈóúÈñâÂ∞çË©±Ê°Ü
    function closeModal() {
      document.getElementById('confirmModal').classList.remove('show');
    }
    
    // Êèê‰∫§È†êÁ¥Ñ
    async function submitBooking() {
      if (!selectedSlot) {
        return;
      }
      
      const currentUser = UserManager.getCurrentUser();
      
      try {
        // Âü∑Ë°åÈ†êÁ¥Ñ
        const appointment = AppointmentManager.bookAppointment(selectedSlot.id, currentUser.id);
        
        // ÈóúÈñâÂ∞çË©±Ê°Ü
        closeModal();
        
        // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
        Utils.showToast('È†êÁ¥ÑÊàêÂäüÔºÅ', 'success');
        
        // Âª∂ÈÅ≤Ë∑≥ËΩâ
        await Utils.sleep(1500);
        window.location.href = 'dashboard.html';
        
      } catch (error) {
        console.error('È†êÁ¥ÑÂ§±Êïó:', error);
        Utils.showToast(error.message || 'È†êÁ¥ÑÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
        closeModal();
      }
    }
    
    // ËøîÂõû
    function goBack() {
      window.history.back();
    }
    
    // È†ÅÈù¢ËºâÂÖ•
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
