<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é¦–é  - DentAI</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <style>
    .welcome-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 0 0 24px 24px;
      margin: -16px -16px 16px -16px;
    }
    
    .welcome-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .welcome-text h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .welcome-text p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .notification-badge {
      position: relative;
      background: rgba(255, 255, 255, 0.2);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .notification-badge:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .notification-count {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #EF4444;
      color: white;
      font-size: 12px;
      font-weight: 700;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 6px;
    }
    
    .health-score-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .score-circle {
      width: 120px;
      height: 120px;
      margin: 0 auto 16px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .score-value {
      font-size: 32px;
      font-weight: 700;
    }
    
    .score-label {
      text-align: center;
      color: #6B7280;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    
    .action-button {
      background: white;
      border: 2px solid #E5E7EB;
      border-radius: 16px;
      padding: 20px 16px;
      text-align: center;
      text-decoration: none;
      color: #111827;
      transition: var(--transition-fast);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .action-button:hover {
      border-color: #3B82F6;
      background: #EFF6FF;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    .action-icon {
      font-size: 32px;
    }
    
    .action-label {
      font-size: 14px;
      font-weight: 600;
    }
    
    .recent-section {
      margin-top: 24px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }
    
    .see-all-link {
      font-size: 14px;
      color: #3B82F6;
      text-decoration: none;
    }
    
    .record-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: var(--transition-fast);
      cursor: pointer;
    }
    
    .record-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .record-date {
      font-size: 14px;
      color: #6B7280;
    }
    
    .record-content {
      font-size: 14px;
      color: #374151;
      margin-bottom: 8px;
    }
    
    .record-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #9CA3AF;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9CA3AF;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .empty-state-hint {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é ‚éƒ¨å°è¦½ -->
    <header class="app-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
      <div style="width: 44px;"></div>
      <h1 class="header-title" style="color: white;">DentAI</h1>
      <div class="notification-badge" id="notificationBtn" style="cursor: pointer; font-size: 24px; position: relative;">
        ğŸ””
        <span class="notification-count" id="notificationCount" style="display: none; position: absolute; top: -4px; right: -4px; background: #EF4444; color: white; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 10px; min-width: 18px; text-align: center;">0</span>
      </div>
    </header>
    
    <!-- å…§å®¹å€åŸŸ -->
    <div class="app-content">
      <!-- æ­¡è¿å€åŸŸ -->
      <div class="welcome-section fade-in">
        <div class="welcome-header">
          <div class="welcome-text">
            <h2 id="userName">è¼‰å…¥ä¸­...</h2>
            <p id="currentDate">-</p>
          </div>
        </div>
        
        <!-- å¥åº·è©•åˆ†å¡ç‰‡ -->
        <div class="health-score-card">
          <div class="score-circle" id="scoreCircle">
            <div class="score-value" style="color: #10B981;">--</div>
          </div>
          <div class="score-label">å£è…”å¥åº·è©•åˆ†</div>
          <div style="text-align: center; font-size: 14px; color: #6B7280;" id="scoreDescription">
            æš«ç„¡è³‡æ–™ï¼Œè«‹ä¸Šå‚³å½±åƒé–‹å§‹è©•ä¼°
          </div>
        </div>
      </div>
      
      <!-- å¿«é€Ÿæ“ä½œ -->
      <div class="quick-actions slide-up">
        <a href="upload.html" class="action-button">
          <div class="action-icon">ğŸ“¸</div>
          <div class="action-label">ä¸Šå‚³å½±åƒ</div>
        </a>
        <a href="history.html" class="action-button">
          <div class="action-icon">ğŸ“Š</div>
          <div class="action-label">æ­·å²è¨˜éŒ„</div>
        </a>
        <a href="report.html" class="action-button">
          <div class="action-icon">ğŸ“‹</div>
          <div class="action-label">å¥åº·å ±å‘Š</div>
        </a>
        <a href="notifications.html" class="action-button">
          <div class="action-icon">ğŸ””</div>
          <div class="action-label">é€šçŸ¥ä¸­å¿ƒ</div>
        </a>
      </div>
      
      <!-- æœ€è¿‘è¨˜éŒ„ -->
      <div class="recent-section">
        <div class="section-header">
          <h3 class="section-title">æœ€è¿‘åˆ†æ</h3>
          <a href="history.html" class="see-all-link">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
        </div>
        
        <div id="recentRecords">
          <!-- å‹•æ…‹è¼‰å…¥ -->
        </div>
      </div>
    </div>
    
    <!-- åº•éƒ¨å°è¦½ -->
    <nav class="bottom-nav">
      <a href="home.html" class="nav-item active">
        <div class="nav-icon">ğŸ </div>
        <div>é¦–é </div>
      </a>
      <a href="upload.html" class="nav-item">
        <div class="nav-icon">ğŸ“¸</div>
        <div>ä¸Šå‚³</div>
      </a>
      <a href="history.html" class="nav-item">
        <div class="nav-icon">ğŸ“Š</div>
        <div>è¨˜éŒ„</div>
      </a>
      <a href="profile.html" class="nav-item">
        <div class="nav-icon">ğŸ‘¤</div>
        <div>æˆ‘çš„</div>
      </a>
    </nav>
  </div>
  
  <script src="../assets/js/storage.js"></script>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/ai-engine.js"></script>
  <script>
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    if (!UserManager.isLoggedIn()) {
      window.location.href = 'login.html';
    }
    
    const currentUser = UserManager.getCurrentUser();
    
    // å¦‚æœæ˜¯é†«å¸«ç™»å…¥ï¼Œè·³è½‰åˆ°é†«å¸«ç«¯
    if (currentUser.type === 'doctor') {
      window.location.href = '../doctor/dashboard.html';
    }
    
    // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
    document.getElementById('userName').textContent = `å—¨ï¼Œ${currentUser.name}`;
    
    // é¡¯ç¤ºç•¶å‰æ—¥æœŸ
    const now = new Date();
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
    document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', dateOptions);
    
    // è¼‰å…¥æœ€æ–°å¥åº·è©•åˆ†
    function loadHealthScore() {
      const analyses = AnalysisManager.getUserAnalyses(currentUser.id);
      
      if (analyses.length > 0) {
        const latestAnalysis = analyses[0];
        const scoreValue = 100 - (latestAnalysis.riskScore * 10);
        const scoreCircle = document.getElementById('scoreCircle');
        const scoreDescription = document.getElementById('scoreDescription');
        
        // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
        scoreCircle.querySelector('.score-value').textContent = Math.max(0, Math.round(scoreValue));
        
        // æ ¹æ“šé¢¨éšªç­‰ç´šæ›´æ–°é¡è‰²
        const colors = {
          low: '#10B981',
          medium: '#F59E0B',
          high: '#EF4444'
        };
        scoreCircle.querySelector('.score-value').style.color = colors[latestAnalysis.riskLevel];
        
        // æ›´æ–°æè¿°
        scoreDescription.textContent = latestAnalysis.riskLevelName + ' - ' + Utils.formatDateTime(latestAnalysis.analyzedAt, 'short') + ' æ›´æ–°';
      }
    }
    
    // è¼‰å…¥é€šçŸ¥æ•¸é‡
    function loadNotificationCount() {
      const unreadCount = NotificationManager.getUnreadCount(currentUser.id);
      const badge = document.getElementById('notificationCount');
      
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    // è¼‰å…¥æœ€è¿‘è¨˜éŒ„
    function loadRecentRecords() {
      const analyses = AnalysisManager.getUserAnalyses(currentUser.id);
      const recentRecordsDiv = document.getElementById('recentRecords');
      
      if (analyses.length === 0) {
        recentRecordsDiv.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <div class="empty-state-text">å°šç„¡åˆ†æè¨˜éŒ„</div>
            <div class="empty-state-hint">é»æ“Šã€Œä¸Šå‚³å½±åƒã€é–‹å§‹æ‚¨çš„å£è…”å¥åº·è¿½è¹¤</div>
          </div>
        `;
        return;
      }
      
      // åªé¡¯ç¤ºæœ€è¿‘ 3 ç­†
      const recentAnalyses = analyses.slice(0, 3);
      
      recentRecordsDiv.innerHTML = recentAnalyses.map(analysis => {
        const riskColors = {
          low: 'var(--risk-low)',
          medium: 'var(--risk-medium)',
          high: 'var(--risk-high)'
        };
        
        const riskIcons = {
          low: 'âœ…',
          medium: 'âš¡',
          high: 'âš ï¸'
        };
        
        return `
          <div class="record-item" onclick="viewAnalysis('${analysis.id}')">
            <div class="record-header">
              <span class="badge badge-${analysis.riskLevel}">
                ${riskIcons[analysis.riskLevel]} ${analysis.riskLevelName}
              </span>
              <span class="record-date">${Utils.getRelativeTime(analysis.analyzedAt)}</span>
            </div>
            <div class="record-content">
              æª¢æ¸¬åˆ° ${analysis.anomalies.length} é …ç•°å¸¸ï¼Œé¢¨éšªè©•åˆ† ${analysis.riskScore}
            </div>
            <div class="record-footer">
              <span>${analysis.status === 'reviewed' ? 'âœ“ å·²å¯©æ ¸' : 'â³ å¾…å¯©æ ¸'}</span>
              <span style="color: ${riskColors[analysis.riskLevel]};">æŸ¥çœ‹è©³æƒ… â†’</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æŸ¥çœ‹åˆ†æè©³æƒ…
    function viewAnalysis(analysisId) {
      window.location.href = `report.html?id=${analysisId}`;
    }
    
    // é€šçŸ¥æŒ‰éˆ•é»æ“Š
    document.getElementById('notificationBtn').addEventListener('click', () => {
      window.location.href = 'notifications.html';
    });
    
    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    loadHealthScore();
    loadNotificationCount();
    loadRecentRecords();
    
    // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡é€šçŸ¥æ•¸é‡
    setInterval(loadNotificationCount, 30000);
  </script>
</body>
</html>
